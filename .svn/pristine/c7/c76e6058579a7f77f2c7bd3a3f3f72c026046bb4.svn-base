<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<script type="text/javascript">
//beforeSend 전역변수 처리
const header="${_csrf.headerName}";
const token ="${_csrf.token}";
const mberId = "${param.mberId}";

console.log("mberId : ",mberId);

window.onload = function(){
	console.log("실행되었습니다~ ")
	
	//날짜 포맷 생성  함수
	function dateFormat(date) {
		let dateFormat2 = date.getFullYear() +
		'-' + ( (date.getMonth()+1) < 9 ? "0" + (date.getMonth()+1) : (date.getMonth()+1) )+
		'-' + ( (date.getDate()) < 9 ? "0" + (date.getDate()) : (date.getDate()) );
		return dateFormat2;
	}
	
	// 방과후버튼 클릭시 생성화면으로 이동하기
	document.querySelector("#addAfterSchool").addEventListener("click", ()=>{
		location.href = "/afterSchool/afterSchoolCreate?schulCode="+"${param.schulCode}";
	});
	
	// 학생 리스트의 결제 완료 버튼 클릭시 수업진행중으로 상태 변경하기
	$(document).on("click",".btnPayDone",function(){
		console.log("결제완료 클릭!");
		
		const atnlcReqstCode = this.closest("tr").querySelector(".atnlcReqstCode").textContent.trim();
		
		let data = {
			"atnlcReqstCode": atnlcReqstCode
		}
		console.log("data : ",data);
		
		$.ajax({
			url : "/afterSchool/lectureStateUpdate",
			contentType : "application/json; charset = utf-8",
			data : JSON.stringify(data),
			type: "post",
			dataType:"json",
			beforeSend : function(xhr){
				xhr.setRequestHeader(header, token);
			},
			success: function(result){
				Swal.fire({
			        title: '학생 상태를 수강중으로 변경하시겠습니까?',
			        text: "수정내용은 바로 반영됩니다.",
			        icon: 'warning',
			        showCancelButton: true,
			        confirmButtonColor: '#3085d6',
			        cancelButtonColor: '#d33',
			        confirmButtonText: '수정',
			        cancelButtonText: '취소',
			        reverseButtons: false, // 버튼 순서 거꾸로
			        
			      }).then((result) => { 
			        if (result.isConfirmed) {
			          Swal.fire(
			            '수강중으로 변경 되었습니다.',
			            '목록으로 이동합니다.',
			            'success'
			          ).then(function(){
			        	  	location.href='/afterSchool/afterSchoolMain?mberId=${memberVO.mberId}';
						});
			        }
			     });
			}
		});
	});
	
	
	// 방과후 학교명 클릭시 해당하는 수강신청한 학생 목록 불러오기
	$(document).on("click",".aAschaNm",function(){
		console.log("클릭이벤트 발생!");
		
		let aschaCode = this.getAttribute("data-ascha-code");
		console.log("aschaCode : ",aschaCode);
		
		let data = {
			"aschaCode": aschaCode
		};
		
		$.ajax({
			url: "/afterSchool/lectureStudentList",
			contentType : "application/json;charset=utf-8",
			data: JSON.stringify(data),
			type: "post",
			dataType: "json",	
			beforeSend: function(xhr){
				xhr.setRequestHeader(header, token);
			},
			success:function(result){
				console.log("result : ", result);
				let str = "";
				
				if(result.length ===0){
					str ="<tr><td colspan='8'>수강신청한 학생이 없습니다.</td></tr>"
				}else{
					result.forEach(function(aschaVO, idx){
						var schulNm  =aschaVO.schulNm  ;
						var cmmnGrade=aschaVO.cmmnGrade;
						var clasNm   =aschaVO.clasNm   ;
						var clasInNo =aschaVO.clasInNo ;
						var mberNm   =aschaVO.mberNm   ;
						var aschaNm  =aschaVO.aschaNm  ;
						var cmmnDetailCode = aschaVO.cmmnDetailCode;
						
						
						$.each(aschaVO.atnlcReqstVOList, function(index, atnlcReqstVO) {
							str +=`
								<tr>
									<td class="atnlcReqstCode" style="display:none;">\${atnlcReqstVO.atnlcReqstCode}</td>
									<td>\${idx+1}</td>
									<td>\${schulNm}</td>
									<td>\${cmmnGrade}학년</td>
									<td>\${clasNm}</td>
									<td>\${clasInNo}</td>
									<td>\${mberNm}</td>
									<td>\${aschaNm}</td>
									<td>`;
							if (cmmnDetailCode==='종강'){
								str += `<button type="button" class="btn btn-custon-rounded-two btn-warning">종강</button>`;
							}else if( cmmnDetailCode==='수업 진행중'){
								str += `<button type="button" class="btn btn-custon-rounded-two btn-primary btnLetureStart">수업 진행중</button>`;
							}else if(cmmnDetailCode==='결제 완료'){
								str += `<button type="button" class="btn btn-custon-rounded-two btn-default btnPayDone">결제 완료</button>`;
							}else if(cmmnDetailCode==='결제 대기'){
								str += `<btton type ="btton" class = "btn btn-custon-rounded-two btn-warning btnPayWait" onclick="sendSMS">결제 대기</button>`
							}else{
								str += `<button type="button" class="btn btn-custon-rounded-two btn-default">취소</button>`;
							}		
							str +=`
								</td>
								</tr>`;
						});

					});
								
				}
				console.log("str : ",str);
				document.querySelector("#lectureStudentListBody").innerHTML = str;
			}
		});
	});
	
	// 선생님이 등록한 방과후학교 목록 불러오기
	let data = {
		"mberId" : mberId	
	};
	console.log("data : ", data);
	
	// 선생님이 등록한 방과후학교 목록 불러오는 ajax
	$.ajax({
		url: "/afterSchool/afterSchoolTeacherList",
		contentType: "application/json ; charset=utf-8",
		data: data,
		type: "get",
		dataType: "json",
		beforeSend : function(xhr){
			xhr.setRequestHeader(header, token);
		},
		success:function(result){
			console.log("result : ", result);
			let str = "";
			result.forEach(function(aschaVO, idx){
				let aschaAtnlcBgnde = dateFormat(new Date(aschaVO.aschaAtnlcBgnde));
				let aschaAtnlcEndde = dateFormat(new Date(aschaVO.aschaAtnlcEndde));
				
				str += `
					<tr>
					<td>\${idx+1}</td>
					<td><a data-ascha-code=\${aschaVO.aschaCode} class="aAschaNm">\${aschaVO.aschaNm}</a></td>
					<td>\${aschaVO.aschaAceptncPsncpa}</td>
					<td>\${aschaAtnlcBgnde}</td>
					<td>\${aschaAtnlcEndde}</td>
					<td>`;
					
				if (aschaVO.cmmnAtnlcNm==='종강'){
					str += `<button type="button" class="btn btn-custon-rounded-two btn-warning">종강</button>`;
				}else if(aschaVO.cmmnAtnlcNm==='수업 진행중'){
					str += `<button type="button" class="btn btn-custon-rounded-two btn-primary">수업 진행중</button>`;
				}else if(aschaVO.cmmnAtnlcNm==='신청 진행중'){
					str += `<button type="button" class="btn btn-custon-rounded-two btn-danger">신청 진행중</button>`;
				}else{
					str += `<button type="button" class="btn btn-custon-rounded-two btn-default">폐강</button>`;
				}
				str +=`	
					</td>
					<td>
						<button class="pd-setting btnUpdate" data-aschaCode="\${aschaVO.aschaCode}">수정하기</button>
					</td>
					</tr>`;
			});
			console.log("str : ", str);
			document.querySelector("#teacherListBody").innerHTML = str;
			
			// 수정 버튼 클릭시 수정화면으로 이동하기
			document.querySelectorAll(".btnUpdate").forEach(function(btn){
					btn.addEventListener("click", ()=>{
						let aschaCode = event.target.getAttribute("data-aschaCode");
						console.log("aschaCode :",aschaCode);
		 				location.href = "/afterSchool/afterSchoolUpdate?aschaCode="+aschaCode+"&schulCode="+"${param.schulCode}";
				});
			});
			
		}
	});
}


</script>

<style>
.content {
	display: flex;
	justify-content: center;
	align-items: center;
}

.single-product-text {
	padding: 5px;
}

.overflow-scroll {
	height: 700px;
	overflow-y: auto; /* 세로 스크롤 설정 */
}

.class-container {
    width: 800px;
    margin: 8px;
    height: 800px;
    border: 1px solid lightgray;
    border-radius: 5px;
    background-color: white;
}
.btn{
    height: 35px;
    width: 90px;
}
button.pd-setting.btnUpdate {
    background: #df3c3c;
}
.btnPayDone{
    color: #fff;
    background-color: #96DB5B;
    border-color: #96DB5B;
}
</style>
<div class="analytics-sparkle-area">
	${param.mberId}의 방과후교실~

	<div class="container-fluid ">
		<div class="row content">
			<div class="class-container">
				<div
					class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
					<div class="courses-title">
						<h2>나의 방과후 개설 목록</h2>
						<!-- 방과후학교 생성 -->
						<button type="button" id="addAfterSchool" class="btn btn-custon-rounded-four btn-primary">방과후학교 생성</button>
						<hr>
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
							style="padding: 0px;">
							<div class="product-status-wrap drp-lst overflow-scroll"
								style="padding: 0px;">
								<table>
									<thead>
										<tr>
											<th>순번</th>
											<th>방과후학교 명</th>
											<th>수용정원(명)</th>
											<th>수강시작일자</th>
											<th>수강종료일자</th>
											<th>상태</th>
											<th>수정</th>
										</tr>
									</thead>
									<tbody id="teacherListBody">
										<!-- 여기에 테이블 내용 추가 -->
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			
			<!-- 수강신청한 학생목록 띄우기 -->
			<div class="class-container">
				<div
					class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
					<div class="courses-title">
						<div>
							<h2>수강신청한 학생 목록</h2>
							<button id="btnAttendCk">출석체크</button>
							<hr>
						</div>
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12"
							style="padding: 0px;">
							<div class="product-status-wrap drp-lst overflow-scroll"
								style="padding: 0px;">
								<table>
									<thead>
										<tr>
											<th>순번</th>
											<th>학교</th>
											<th>학년</th>
											<th>반</th>
											<th>번호</th>
											<th>이름</th>
											<th>방과후학교명</th>
											<th>상태</th>
										</tr>
									</thead>
									<tbody id="lectureStudentListBody">
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

