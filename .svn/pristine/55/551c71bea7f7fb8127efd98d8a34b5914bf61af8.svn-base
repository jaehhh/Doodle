<%@ page language="java" contentType="text/html; charset=UTF-8"
   pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<style>
.images{
	width: 120px;
	height: 120px;
	object-fit: cover;
	border-radius: 10px;
	margin: 5px;
	margin-top: 10px;
}
.ntcnContent{
	width: 100%;
}
/* .images:hover{ */
/* 	backdrop-filter: blur(10px); */
/* } */

.images img:hover{
	backdrop-filter: blur(10px);
}
.ntcnAll{
	width: auto;
	margin: auto;
	backdrop-filter: blur(10px);
	background-color: rgba(255, 255, 255, 1);
	border-radius: 50px;
	box-shadow: 0px 35px 68px 0px rgba(145, 192, 255, 0.5), inset 0px -6px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
	padding: 50px 80px;
	margin-bottom:50px;
	min-height:850px;"
}

.ntcnAll .ntcn-cont{
	border: 1px solid #ddd;
	border-radius: 10px;
	padding: 10px 20px;
	min-height: 83px;
	margin-top: 20px;
}

.btnContainer{
   display: flex;
   justify-content: center;
}
.btnContainer .btn {
    margin-right: 10px;
}
.file-upload {
  width: 100%;
}
.input {
  display: flex;
  align-items: center;
}
.prepend-big-btn {
  position: ;
}
.icon-right {
  margin-right: 10px;
}
.file-button {
  background-color: #007bff;
  color: #fff;
  padding: 8px 16px;
  margin-right: 10px;
  cursor: pointer;
  
}
.file-button input {
  display: none;
}
.file-button label {
  cursor: pointer;
}
.file-upload input[type="text"] {
  flex-grow: 1;
/*   margin-left: 10px; */
  padding: 8px;
  border: 1px solid #ced4da;
  width: calc(100% - 100px - 10px - 16px); /* Subtract button width and margins */
}
.input-file-button{
  background-color:#007bff;
  border-radius: 4px;
  color: white;
  cursor: pointer;
}

.task-form{
  margin-top: 10px;
}

.file-name{
  width: 300px;
  height: 32px;
  border-style: none;
}

.form-control{
  width: 100%;
}

label{
  margin-bottom: 0px;
}

.file-upload-div {
/*     cursor: pointer; */
    border: 2px dashed #ccc;
    margin: 0px 0px;
    padding: 20px;
    text-align: center;
}

</style>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<!-- 네이버 스마트 에디터 JS -->
<script type="text/javascript" src="/resources/se2/js/HuskyEZCreator.js" charset="UTF-8"></script>
<script type="text/javascript">
// 전역 변수
var clasCode = "${CLASS_INFO.clasCode}";
var schulCode = "${CLASS_INFO.schulCode}";
var taskCode = "${taskCode}";
var loginId = "${USER_INFO.mberId}";

var files = [];
var index = 0;

var oEditors = [];

// 이미지 드래그 앤 드롭
window.onload = function(){
	var fu = document.querySelector('.file-upload-div');
    var imgStr = "";
	 /* 박스 안에 Drag 들어왔을 때 */
// 	fu.addEventListener('dragenter', function(e){
// 	});
	
	/* 박스 안에 Drag를 하고 있을 때 */
	fu.addEventListener('dragover', function(e) {
        e.preventDefault();
    });
	
	/* 박스 안에서 Drag를 Drop했을 때 */
    fu.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.backgroundColor = 'white';
        
        // 드래그한 파일들을 files에 추가
	    for (var i = 0; i < e.dataTransfer.files.length; i++) {
	        files.push(e.dataTransfer.files[i]);
	        
	        var fileName = [];
	        fileName[i] = e.dataTransfer.files[i].name;
	        
	        // 이미지 태그 동적 생성
	    	var imgTag = document.createElement('img');
	    	imgTag.setAttribute('id', 'images'+(index++));
	    	imgTag.setAttribute('class', 'images');
	    	imgTag.setAttribute('src', '/resources/images/classRoom/notice/'+fileName[i]);
	       
	    	var imageDiv = document.querySelector("#imageDiv");
	        imageDiv.appendChild(imgTag);
	    }
        console.log("드래그 files", files);
        
//         imageDiv.innerHTML = imgStr;
//         console.log(imgStr);
    });
	
    /* 박스 밖으로 Drag가 나갈 때 */
//     fu.addEventListener('dragleave', function(e) {
//         this.style.backgroundColor = 'gray';
//     });
}

$(function(){
	// 소켓 객체 생성
    var soc = new SockJS("/alram");
	
	$("#uploadBtn").on("click", function(){
		$("#inputImage").trigger("click");
	});
	
	// 파일 이름 넣기
	$("#inputImage").on("input", function() {
		var inputImage = $("#inputImage")[0];

		// 업로드한 파일 가져와서 넣기
		for (var i = 0; i < inputImage.files.length; i++) {
	        files.push(inputImage.files[i]);
	        
			// 이미지 태그 동적 생성
	    	var imgTag = document.createElement('img');
	    	imgTag.setAttribute('id', 'images'+(index++));
	    	imgTag.setAttribute('class', 'images');
	    	imgTag.setAttribute('src', '/resources/images/classRoom/notice/'+inputImage.files[i].name);
	       
	    	var imageDiv = document.querySelector("#imageDiv");
	        imageDiv.appendChild(imgTag);
		}
		
        console.log("첨부 files", files);
        
	});
	
	// 첨부한 사진 개별 삭제 이벤트
	$(document).on("click", ".images", function(){
		var imageId = $(this).attr("id"); // 클릭한 이미지의 id 가져오기
	    var idx = imageId.replace("images", ""); // images를 제거하여 인덱스 추출
		alert(idx);
		  
	    delete files[idx];
		console.log(files);
	    
	    $("#images"+idx).remove();
	    
		console.log("삭제 후", files);
	});
      
	// 알림장 게시글 등록
	$("#ntcnInsertBtn").click(function() {
// 		fileCheck();
		oEditors.getById["se2Cn"].exec("UPDATE_CONTENTS_FIELD", []);
        
        // 입력 정보들 가져오기
        var ntcnSj = $("#ntcnSj").val();
        console.log("ntcnSj: " + ntcnSj);
	    
        // 에디터에 적은 내용 가져오기
        var ntcnCn = oEditors.getById["se2Cn"].getIR();
        $("#ntcnCn").val(ntcnCn);
        console.log("ntcnCn: " + ntcnCn);
        
        // 업로드한 파일 가져오기
        // 개별 삭제 되어 empty처리 된 인덱스 필터 작업
		files = files.filter(function(item){
			return item !== undefined && item !== null;
		});
		
		console.log("필터 후 files", files);
		
        var formData = new FormData();
        formData.append("clasCode", clasCode);
        formData.append("ntcnSj", ntcnSj);
        formData.append("ntcnCn", ntcnCn);
         
        for (var i = 0; i < files.length; i++) {
        	formData.append("uploadFiles", files[i]);
        };
         
        $.ajax({
	        url: "/ntcn/ntcnInsert",
	        processData: false,
	        contentType: false,
	        type: "POST",
	        data: formData,
	        dataType: "text",
	        beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
	        },
           	success: function(ntcnCode){
           		alert("알림장 등록 성공!");
	            console.log("ntcnCode", ntcnCode);
	            
	           // taskCode = res.taskCode;
// 				taskSj = "[과제] " + taskSj;
// 				var noticeCn = "새 과제가 등록되었습니다.";
				
// 				var data = {
// 					"noticeSndId":loginId,
// 					"clasCode":clasCode,
// 					"taskCode":taskCode,
// 					"noticeSj":taskSj,
// 					"noticeCn":noticeCn
// 				};
				
// 				// 과제 게시글 등록 -> 알림 테이블 insert
// 		        $.ajax({
// 		        	url: "/task/noticeInsertAll",
// 		        	contentType:"application/json;charset=utf-8",
// 		        	type: "post",
// 		        	data: JSON.stringify(data),
// 		        	dataType: "text",
// 		        	beforeSend:function(xhr){
// 						xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
// 			        },
// 		           	success: function(res){
// 		           		alert("모두에게 알림 잘 보냈어유");
		           		
// 						// 소켓 객체 생성
// 			            var soc = new SockJS("/alram");
			            
// 			            var str = "";
// 			            str += "<div class='single-review-st-text'>";
// 			            str += "<img src='/resources/images/classRoom/task/taskCheck.png' alt='' style='margin-left: 15px; width: 40px; height: 40px;'>";
// 			            str += "<div class='review-ctn-hf'>";
// 			            str += "<a id='readNotice' href='/task/taskList?clasCode="+clasCode+"'>";
// 			            str += "<h3>"+taskSj+"</h3>";
// 			            str += "<p>"+noticeCn+"</p>";
// 			            str += "</a>";
// 			            str += "</div>";
		               
// 			            // 학생, 학부모 모두에게 보내기
// 						var msg = str+",toAll";
						
// 						soc.onopen = function() {
// 						   soc.send(msg);
// 						   alert("메세지 보냈다.");
// 						};
						
				        location.href = "/ntcn/goToNtcn?clasCode="+clasCode;
// 		           	}
// 		        });
				
			}
		});
	});
	
});
// 네이버 스마트 에디터 API
$(function() {
	nhn.husky.EZCreator.createInIFrame({
      oAppRef : oEditors,
      elPlaceHolder : "se2Cn",
      //SmartEditor2Skin.html 파일이 존재하는 경로
      sSkinURI : '<c:url value="/resources/se2/SmartEditor2Skin.html"/>',
      htParams : {
         bUseToolbar : true,          // 툴바 사용 여부 (true:사용/ false:사용하지 않음)
         bUseVerticalResizer : true,  // 입력창 크기 조절바 사용 여부 (true:사용/ false:사용하지 않음)
         bUseModeChanger : true,      // 모드 탭(Editor | HTML | TEXT) 사용 여부 (true:사용/ false:사용하지 않음)
         bSkipXssFilter : true,       // client-side xss filter 무시 여부 (true:사용하지 않음 / 그외:사용)
         //aAdditionalFontList : aAdditionalFontSet,      // 추가 글꼴 목록
         fOnBeforeUnload : function(){
            //alert("완료!");
         },
//                  I18N_LOCALE : sLang
         }, //boolean
         fOnAppLoad : function(){
               //예제 코드
//                  oEditors.getById["se2Cn"].exec("PASTE_HTML", ["로딩이 완료된 후에 본문에 삽입되는 text입니다."]);
         },
      fCreator: "createSEditor2"
   });
});

function fileCheck() {
	//input file 태그.
	var file = document.getElementById('inputImage');
	//파일 경로.
	var filePath = file.value;
	//전체경로를 \ 나눔.
	var filePathSplit = filePath.split('\\'); 
	//전체경로를 \로 나눈 길이.
	var filePathLength = filePathSplit.length;
	//마지막 경로를 .으로 나눔.
	var fileNameSplit = filePathSplit[filePathLength-1].split('.');
	//파일명 : .으로 나눈 앞부분
	var fileName = fileNameSplit[0];
// 	//파일 확장자 : .으로 나눈 뒷부분
// 	var fileExt = fileNameSplit[1];
// 	//파일 크기
// 	var fileSize = file.files[0].size;
	
	console.log('파일 경로 : ' + filePath);
	console.log('파일명 : ' + fileName);
// 	console.log('파일 확장자 : ' + fileExt);
// 	console.log('파일 크기 : ' + fileSize);
}
</script>

<div class="ntcnAll">
<div class="col-md-12 col-md-12 col-sm-12 col-xs-12 ntcnContent">
	<div class="hpanel email-compose">
		<div class="panel-heading hbuilt">
			<h3 style="text-align: center;">알림 등록</h3>
			<hr>
		</div>
		<div class="panel-heading hbuilt">
			<div class="p-xs">
				<div class="input prepend-big-btn" style="margin-bottom: 20px;">
					<input type="text" name="ntcnSj" id="ntcnSj" placeholder="제목을 입력하세요" class="form-control input-sm">
					<input type="file" value="파일 첨부" name="uploadFile" id="inputImage" multiple style="display: none;">
				</div>
				<textarea name="se2Cn" id="se2Cn" style="width: 100%; height: 412px;">
				</textarea>
				<textarea name="ntcnCn" id="ntcnCn" style="width: 100%; height: 200px; display: none;">
				</textarea>
					<div class="form-group" style="margin: 0; margin-top: 20px;">
						<div class="file-upload-div">
							<i class="fa fa-cloud-download" aria-hidden="true"
								style="color: #999; font-size: 50px;"></i>
							<p>
								드래그 혹은 클릭하여 파일을 업로드 해주세요<br>이미지 파일(jpeg, png)만 업로드 가능
							</p>
							<button id="uploadBtn" class="d-btn-black">파일 업로드</button>
							<div id="imageDiv">
								<!-- 								<img src='/resources/images/notice/짱구악당.jpg'><img src='/resources/images/notice/박명수.JPG'> -->
							</div>
							<!-- 							<input name="imageico" class="hd-pro-img" type="text"> -->
						</div>
					</div>
			</div>
		</div>

		<div class="row">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
				<div class="btnContainer">
					<input type="button" id="ntcnInsertBtn"
						class="btn btn-primary waves-effect waves-light btn" value="등록">
					<input type="button" value="취소"
						class="btn btn-primary waves-effect waves-light btn"
						onclick="location.href='/ntcn/goToNtcn?clasCode=${CLASS_INFO.clasCode}'">
					<input type="file" multiple="multiple" class="dz-hidden-input"
						style="visibility: hidden; position: absolute; top: 0px; left: 0px; height: 0px; width: 0px;">
				</div>
			</div>
		</div>
	</div>
</div>
</div>