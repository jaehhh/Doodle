<%@ page language="java" contentType="text/html; charset=UTF-8"
   pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<style>
.images{
	width: 90px;
	height: 90px;
	object-fit: cover;
	border-radius: 5px;
	margin: 7px 0px 7px 7px;
/* 	margin-top: 10px; */
	cursor: pointer;
}
.images:hover{
/* 	border: 2px solid blue; */
}

#ntcnTitle h3{
font-size: 2.2rem;
text-align: center;
backdrop-filter: blur(4px);
background-color: rgba(255, 255, 255, 1);
border-radius: 50px;
box-shadow: 35px 35px 68px 0px rgba(145, 192, 255, 0.5), inset -8px -8px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
width: 370px;
padding-top: 35px;
padding-bottom: 35px;
margin: auto;
margin-bottom: 40px;
}
.ntcnContent{
	width: 100%;
}
.ntcnAll{
	width: 1400px;
	margin: auto;
	backdrop-filter: blur(10px);
	background-color: rgba(255, 255, 255, 1);
	border-radius: 50px;
	box-shadow: 0px 35px 68px 0px rgba(145, 192, 255, 0.5), inset 0px -6px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
	padding: 50px 80px;
	margin-bottom:50px;
	height:1000px;"
}

.ntcnAll .ntcn-cont{
	border: 1px solid #ddd;
	border-radius: 10px;
	padding: 10px 20px;
	min-height: 83px;
	margin-top: 20px;
}

.btnContainer{
   display: flex;
   justify-content: center;
}
.btnContainer .btn {
    margin-right: 10px;
}
.file-upload {
  width: 100%;
}
.input {
  display: flex;
  align-items: center;
}
.prepend-big-btn {
  position: ;
}
.icon-right {
  margin-right: 10px;
}
.file-button {
  background-color: #007bff;
  color: #fff;
  padding: 8px 16px;
  margin-right: 10px;
  cursor: pointer;
  
}
.file-button input {
  display: none;
}
.file-button label {
  cursor: pointer;
}
.file-upload input[type="text"] {
  flex-grow: 1;
/*   margin-left: 10px; */
  padding: 8px;
  border: 1px solid #ced4da;
  width: calc(100% - 100px - 10px - 16px); /* Subtract button width and margins */
}
.input-file-button{
  background-color:#007bff;
  border-radius: 4px;
  color: white;
  cursor: pointer;
}

.task-form{
  margin-top: 10px;
}

.file-name{
  width: 300px;
  height: 32px;
  border-style: none;
}

.form-control{
  width: 100%;
}

label{
  margin-bottom: 0px;
}

#imageDiv{
	display: flex;
	justify-content: flex-start;
	border: 2px dashed #ccc;
	height: 105px;
}

.file-upload-div {
/*     cursor: pointer; */
    border: 2px dashed #ccc;
    margin: 0px 0px;
    padding: 30px;
    text-align: center;
}

</style>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<!-- 네이버 스마트 에디터 JS -->
<script type="text/javascript" src="/resources/se2/js/HuskyEZCreator.js" charset="UTF-8"></script>
<script type="text/javascript">
// 전역 변수
var clasCode = "${CLASS_INFO.clasCode}";
var schulCode = "${CLASS_INFO.schulCode}";
var taskCode = "${taskCode}";
var loginId = "${USER_INFO.mberId}";

var files = [];
var index = 0;

var oEditors = [];

function fn_deleteOne(param){
// 	var data = {"atchFileCours":param};
	$.ajax({
		url:"/ntcn/atchFileDeleteOne",
		type:"post",
		data: {"atchFileCours":param},
		dataType: "text",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
        },
       	success: function(ntcnCode){
			alert("개별삭제성공");
       	}	
	})
}

// 이미지 드래그 앤 드롭
window.onload = function(){
	var fu = document.querySelector('.file-upload-div');
    var imgStr = "";
	 /* 박스 안에 Drag 들어왔을 때 */
// 	fu.addEventListener('dragenter', function(e){
// 	});
	
	/* 박스 안에 Drag를 하고 있을 때 */
	fu.addEventListener('dragover', function(e) {
        e.preventDefault();
    });
	
	/* 박스 안에서 Drag를 Drop했을 때 */
    fu.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.backgroundColor = 'white';
        
        // 드래그한 파일들을 files에 추가
	    for (var i = 0; i < e.dataTransfer.files.length; i++) {
	    	// 이미지 파일이 아니면 return
			if(e.dataTransfer.files[i].type != "image/jpeg" && e.dataTransfer.files[i].type != "image/png" && e.dataTransfer.files[i].type != "image/gif"){
				Swal.fire({
				  title: '이미지 파일만 업로드 가능합니다.',
				  text: '',
				  icon: 'error'
				});
				return;
			}

	        files.push(e.dataTransfer.files[i]);
	        
	        var fileName = [];
	        fileName[i] = e.dataTransfer.files[i].name;
	        
	        // 이미지 태그 동적 생성
	    	var imgTag = document.createElement('img');
	    	imgTag.setAttribute('id', 'images'+(index++));
	    	imgTag.setAttribute('class', 'images');
	    	imgTag.setAttribute('src', '/resources/images/classRoom/notice/'+fileName[i]);
	       
	    	var imageDiv = document.querySelector("#imageDiv");
	        imageDiv.appendChild(imgTag);
	    }
        
        console.log("드래그 files", files);
    });
	
    /* 박스 밖으로 Drag가 나갈 때 */
    fu.addEventListener('dragleave', function(e) {
// 		var atchFileCours = $(".images").attr("data-atchFileCours");
// 		alert(atchFileCours);
		
// 		$("#imageDiv img[data-atchFileCours='" + atchFileCours + "']").remove();
		
// 		fn_deleteOne(atchFileCours);
		
// 		var imageId = $(".images").attr("id"); // 클릭한 이미지의 id 가져오기
// 	    var idx = imageId.replace("images", ""); // images를 제거하여 인덱스 추출
// 		alert(idx);
		  
// 	    delete files[idx];
// 		console.log(files);
	    
// 	    $("#images"+idx).remove();
	    
// 		console.log("삭제 후", files);
    });
}

$(function(){
	// 소켓 객체 생성
    var soc = new SockJS("/alram");
	
	$("#uploadBtn").on("click", function(){
		$("#inputImage").trigger("click");
	});
	
	// 파일 이름 넣기
	$("#inputImage").on("input", function() {
		var inputImage = $("#inputImage")[0];

		// 업로드한 파일 가져와서 넣기
		for (var i = 0; i < inputImage.files.length; i++) {
	        files.push(inputImage.files[i]);
	        
			// 이미지 태그 동적 생성
	    	var imgTag = document.createElement('img');
	    	imgTag.setAttribute('id', 'images'+(index++));
	    	imgTag.setAttribute('class', 'images');
	    	imgTag.setAttribute('src', '/resources/images/classRoom/notice/'+inputImage.files[i].name);
	       
	    	var imageDiv = document.querySelector("#imageDiv");
	        imageDiv.appendChild(imgTag);
		}
		
        console.log("첨부 files", files);
        
	});
	
	// 첨부한 사진 개별 삭제 이벤트
	$(document).on("click", ".images", function(){
		var atchFileCours = $(this).attr("data-atchFileCours");
// 		alert(atchFileCours);
		
		$("#imageDiv img[data-atchFileCours='" + atchFileCours + "']").remove();
		
		fn_deleteOne(atchFileCours);
		
		var imageId = $(this).attr("id"); // 클릭한 이미지의 id 가져오기
	    var idx = imageId.replace("images", ""); // images를 제거하여 인덱스 추출
// 		alert(idx);
		  
	    delete files[idx];
		console.log(files);
	    
	    $("#images"+idx).remove();
	    
		console.log("삭제 후", files);
		
	});
      
	// 알림장 게시글 수정
	$("#ntcnUpdateBtn").click(function() {
        var atchfilecours = $(".images").attr("data-atchfilecours");
		oEditors.getById["se2Cn"].exec("UPDATE_CONTENTS_FIELD", []);
        
        // 입력 정보들 가져오기
        var ntcnSj = $("#ntcnSj").val();
        console.log("ntcnSj: " + ntcnSj);
	    
        // 에디터에 적은 내용 가져오기
        var ntcnCn = oEditors.getById["se2Cn"].getIR();
        $("#ntcnCn").val(ntcnCn);
        console.log("ntcnCn: " + ntcnCn);
        
        // 업로드한 파일 가져오기
        // 개별 삭제 되어 empty처리 된 인덱스 필터 작업
		files = files.filter(function(item){
			return item !== undefined && item !== null;
		});
		
		console.log("필터 후 files", files);
		
        var formData = new FormData();
        formData.append("ntcnCode", "${ntcnVO.ntcnCode}");
        
		if(atchfilecours != null){
	        formData.append("atchFileCode", "${ntcnVO.atchFileCode}");
        }else{
	        formData.append("atchFileCode", "");
        }
		
        formData.append("ntcnSj", ntcnSj);
        formData.append("ntcnCn", ntcnCn);
         
        for (var i = 0; i < files.length; i++) {
        	formData.append("uploadFiles", files[i]);
        };
        
        $.ajax({
	        url: "/ntcn/ntcnUpdate",
	        processData: false,
	        contentType: false,
	        type: "POST",
	        data: formData,
	        dataType: "text",
	        beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
	        },
           	success: function(ntcnCode){
           		alert("알림장 수정 성공!");
	            console.log("ntcnCode", ntcnCode);
						
		        location.href = "/ntcn/ntcnList?clasCode="+clasCode;
			}
		});
	});
	
});
// 네이버 스마트 에디터 API
$(function() {
	nhn.husky.EZCreator.createInIFrame({
      oAppRef : oEditors,
      elPlaceHolder : "se2Cn",
      //SmartEditor2Skin.html 파일이 존재하는 경로
      sSkinURI : '<c:url value="/resources/se2/SmartEditor2Skin.html"/>',
      htParams : {
         bUseToolbar : true,          // 툴바 사용 여부 (true:사용/ false:사용하지 않음)
         bUseVerticalResizer : true,  // 입력창 크기 조절바 사용 여부 (true:사용/ false:사용하지 않음)
         bUseModeChanger : true,      // 모드 탭(Editor | HTML | TEXT) 사용 여부 (true:사용/ false:사용하지 않음)
         bSkipXssFilter : true,       // client-side xss filter 무시 여부 (true:사용하지 않음 / 그외:사용)
         //aAdditionalFontList : aAdditionalFontSet,      // 추가 글꼴 목록
         }, //boolean
      fCreator: "createSEditor2"
   });
});
</script>

<div id="ntcnTitle">
	<div class="sparkline13-list">
		<h3>
			<img src="/resources/images/classRoom/notice/noticeContent.png" style="width:50px; margin-bottom: 5px; display:inline-block; vertical-align:middel;">
				알림장
			<img src="/resources/images/classRoom/notice/star.png" style="width:40px; margin-bottom: 10px; display:inline-block; vertical-align:middel;">		
		</h3>
	</div>
</div>

<div class="ntcnAll">
<div class="col-md-12 col-md-12 col-sm-12 col-xs-12 ntcnContent">
	<div class="hpanel email-compose">
		<div class="panel-heading hbuilt">
			<div class="p-xs">
				<div class="input prepend-big-btn" style="margin-bottom: 20px;">
					<input type="text" id="ntcnSj" value="${ntcnVO.ntcnSj}" class="form-control input-sm">
					<input type="file" value="파일 첨부" name="uploadFile" id="inputImage" accept="image/*" multiple style="display: none;">
				</div>
				<textarea name="se2Cn" id="se2Cn" style="width: 100%; height: 412px;">
				${ntcnVO.ntcnCn}
				</textarea>
				<textarea name="ntcnCn" id="ntcnCn" style="width: 100%; height: 200px; display: none;">
				</textarea>
				<div id="imageDiv">
						<c:if test="${ntcnVO.atchFileCode != null}">
							<c:forEach var="atchFileVO" items="${atchFileList}" varStatus="status">
								<img class="images" alt="이미지 파일" src="/upload/ntcn/${atchFileVO.atchFileCours}"
									data-atchFileCours='${atchFileVO.atchFileCours}'>
							</c:forEach>
						</c:if>
					</div>
				<div class="form-group" style="margin: 0; margin-top: 20px;">
					<div class="file-upload-div">
						<i class="fa fa-cloud-download" aria-hidden="true"
							style="color: #999; font-size: 50px;"></i>
						<p>
							드래그 혹은 파일 업로드 클릭하여 파일을 업로드 해주세요<br>이미지 파일(jpeg, png)만 업로드 가능
						</p>
						<button id="uploadBtn" class="d-btn-black">파일 업로드</button>
						<div class="form-group" style="margin: 0; margin-top: 20px;">
					
				</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
				<div class="btnContainer">
					<input type="button" id="ntcnUpdateBtn"
						class="btn btn-primary waves-effect waves-light btn" value="수정">
					<input type="button" value="취소"
						class="btn btn-primary waves-effect waves-light btn"
						onclick="location.href='/ntcn/ntcnList?clasCode=${CLASS_INFO.clasCode}'">
					<input type="file" multiple="multiple" class="dz-hidden-input"
						style="visibility: hidden; position: absolute; top: 0px; left: 0px; height: 0px; width: 0px;">
				</div>
			</div>
		</div>
	</div>
</div>
</div>