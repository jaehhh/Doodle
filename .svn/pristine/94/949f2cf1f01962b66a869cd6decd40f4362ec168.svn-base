<%@page import="kr.or.ddit.vo.MemberVO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<!DOCTYPE html>
<style>
/* html,body {width:100%;  } */
/* body,div,ul,li{margin:0; padding:0;} */
/* ul,li {list-style:none;} */

#profileImg{
	width: 200px; height: 200px;
	border-radius: 70%;
	object-fit: cover;
}
   
#childImage{
	width: 60px; height: 60px;
	border-radius: 70%;
	object-fit: cover;
}

#FreeBoardContainer h4{
	font-size: 2.2rem;
	text-align: center;
	margin-top: 60px;
	backdrop-filter: blur(4px);
	background-color: rgba(255, 255, 255, 1);
	border-radius: 50px;
	box-shadow: 35px 35px 68px 0px rgba(145, 192, 255, 0.5), inset -8px -8px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
	width: 370px;
	padding-top: 35px;
	padding-bottom: 35px;
	margin: auto;
	margin-top: 50px;
	margin-bottom: 40px;
}

.FreeBoardAll{
	width: 1250px;
	margin: auto;
	backdrop-filter: blur(10px);
	background-color: rgba(255, 255, 255, 1);
	border-radius: 50px;
	box-shadow: 0px 35px 68px 0px rgba(145, 192, 255, 0.5), inset 0px -6px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
	padding: 50px 80px;
}

.FreeBoardAll .free-cont{
	border: 1px solid #ddd;
	border-radius: 10px;
	padding: 10px 20px;
	min-height: 83px;
	margin-top: 50px;
}
.FreeBoardAll .FreeTit {
	display: flex;
	justify-content: space-between;
	position:relative;
}


.FreeBoardAll .title{
	font-size: 1.8rem;
	font-weight: 700;
	margin-top: 6px;
}

#goToTaskList, #deleteBtn, #updateBtn{
	display:inline-block;
	text-align: center;
	background: #006DF0;
	padding: 15px 30px;
	font-size: 1rem;
	border: none;
	color: #fff;
	font-weight: 700;
	border-radius: 5px;
	margin-top: 30px;
	margin-bottom: 40px;
	margin-right:15px;
}
#deleteBtn{
	background: #111;
	color:#fff;
}

#updateBtn{
	background: #666;
	color:#fff;
}

#goToTaskList:hover,#updateBtn:hover,deleteBtn:hover{
	background: #ffd77a;
	transition: all 1s ease;
	color:#333;
}

.uploadList{
	background: rgb(178 202 255 / 25%);
	backdrop-filter: blur(4px);
	-webkit-backdrop-filter: blur(4px);
	border-radius: 10px;
	border: 1px solid rgba(255, 255, 255, 0.18);
	padding: 15px 20px;
}

.uploadList ul{
	display: block;
}
.uploadList ul li{
	display: block;
	margin-bottom:5px;
}

.uploadList ul li.fileList{
	cursor: pointer;
}
.uploadList ul li.fileList:hover{
	text-decoration: underline;
}

.btn-zone{
	margin: auto;
	text-align: center;
}

.freeInfo{
	display: flex;
	justify-content: flex-start;
	margin-top: 20px;
	padding-left: 10px;
	font-size: 1rem;
}
</style>
<script type="text/javascript" src="/resources/js/jquery.min.js" ></script>
<script type="text/javascript">

<% MemberVO memVO = (MemberVO) request.getAttribute("memVO"); %>

$(function(){
	$('.tabcontent > div').hide();
	
	$('.tabnav a').click(function() {
		console.log("왔다");
		$('.tabcontent > div').hide().filter(this.hash).fadeIn();
		$('.tabnav a').removeClass('active');
		$(this).addClass('active');
	  
		let mberId = "${memVO.mberId}";
		//mberId : aquaMom
		console.log("mberId : " + mberId);
		
		$.ajax({
			url:"/parents/getChildList",
			type:"post",
			dataType:"json",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success:function(result){
				console.log("result1 : ", result);
				console.log("결과좀알자1: ", result[0].schulPsitnMberVOList[0].memberVOList);
				console.log("결과좀알자2: ", result[0].schulPsitnMberVOList[1].memberVOList);
				console.log("결과좀알자3: ", result[1].schulPsitnMberVOList[0].memberVOList);
				
				let mberSortNm = result[0].mberSortNm;
				let index = 1;
				
				$.each(result[0].schulPsitnMberVOList,function(idx,schulPsitnMberVO){
// 					var str = "<li>자녀 아이디: "+schulPsitnMberVO.mberId+"</li>";
// 		 			str += "<li>자녀 명: "+schulPsitnMberVO.mberNm+"</li>";
// 		 			str += "<li>가족 관계: "+mberSortNm+"</li>";
					console.log("결과 좀 알자4: ", result[0].schulPsitnMberVOList);

					var resultTest = result[0].schulPsitnMberVOList;
					console.log("되나?", resultTest[0].memberVOList);
					var memberVO = resultTest[0].memberVOList[0];
					console.log("memberNm: " + memberVO.mberNm);
					
		 			var str = "<tr>";
		 			str += "<td>"+index+"</td>";
		 			str += "<td><img id='childImage' src='/resources/images/student/루피1.png' alt=''></td>";
		 			
		 			str += "<td>"+schulPsitnMberVO.mberNm+"</td>";	// 자녀 이름
		 			str += "<td>"+schulPsitnMberVO.mberNm+"</td>";	// 자녀 이메일
		 			str += "<td>"+(index+1)+"</td>";				// 자녀 전화번호
		 			str += "<td>"+schulPsitnMberVO.mberNm+"</td>";
// 		 			<td>학교</td>
// 		 			<td>클래스</td>
// 		 			<td>모</td>
		 			str += "</tr>";
					
// 		 			$("#childInfoTbody").html(str);
// 		 			$("#childListTab0" + (idx+1)).html(str);
		 			
		 			$.each(result[1].schulPsitnMberVOList,function(idx,schulPsitnMberVO){
		 				str = "<li>자녀 아이디: "+schulPsitnMberVO.mberId+"</li>";
			 			str += "<li>자녀 명: "+schulPsitnMberVO.mberNm+"</li>";
			 			str += "<li>가족 관계: "+mberSortNm+"</li>";
			 			
				 		$("#childListTab0" + (idx+2)).html(str);
		 			});
		 			
			 		
			 		var str2 = "<li>클래스 명: " + ${myClassList[0].clasVOList[0].clasNm} + "</li>";
			 		
// 			 		$("#childSchulInfo").html(str);
// 			 		$("#childClassInfo").html(str);
				});
			}
		});
		
		// 자녀 소속 학교 리스트
		$.ajax({
			url:"/parents/getChildSchulList",
			type:"post",
			dataType:"json",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
			success:function(result){
				console.log("result2: ", result);
				
				var index = 0;
				var str = "";
				
				$.each(result[index].schulVOList, function(idx, schulVO){
					str += "<li>학교 주소: "+schulVO.schulAdres+"</li>";
					str += "<li>학교 : "+schulVO.schulNm+"</li>";
					str += "<li>전화번호: "+schulVO.schulTlphonNo+"</li>";
				});
		 		
				$("#childSchulInfo").html(str);
			}
		});
			
	  return false;
	  
	}).filter(':eq(0)').click();
	
	// 비밀번호 변경 모달 창 띄우기
// 	$("#UpdatePasswordModal").modal('show');
	
	// 비밀번호 변경
	$("#UpdatePasswordBtn").on("click", function(){
		var mberId = ${memVO.mberId};
		var pw1 = $("#password1").val();
		var pw2 = $("#password2").val();
		
	    // 비밀번호 유효성 검사
	    if(pw1 != pw2 || pw1 == "" || pw2 == ""){
	        $("#pwChk").removeAttr("style");
	        $("#pwChk").html("비밀번호가 일치하지 않거나 올바르게 입력되지 않았습니다.");
	        return;
	    }
		
    	var formData = new FormData();
    	
    	formData.append("password", pw1);
    	formData.append("mberId", mberId);
		
    	$.ajax({
    		url: "/parents/updatePassword",
    		processData: false,
    		contentType: false,
    		type:"post",
    		data:formData,
    		dataType:"text",
    		beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
    		success: function(res){
    			location.href = "/parents/mypage";
    		}
    	});
	});
	
	// 사진 올리기
    $("#inputImage").on("input", function() {
        var uploadFile = $(this).val();
        console.log("uploadFile: " + uploadFile);
        
        // 사진 업로드 취소 시
        if(uploadFile == null){
        	history.go(-1);
        }
        
        // 파일 이름 추출하기(ex: 루피.jpg)
        var index = uploadFile.lastIndexOf('\\');
        console.log("index: " + index);
        var fileName = uploadFile.substring(index + 1);
        console.log("fileName: " + fileName);

        var imgSrc = "/resources/images/parents/" + fileName;
		
        if(index > 0){
			$("#profileImg").attr("src", imgSrc);        	
        };
		
        $("#mberImage").val(fileName);
        
        // 올린 사진 원래대로 변경하는 작업도 추가...
    });

    // 수정 모드 전환
    $("#updateBtn").on("click", function() {
		$(".form-control").removeAttr("readonly");
		$("#updateLabel").removeAttr("style");
		$("#updateBtn").attr("type", "hidden");
		$("#updateProfileBtn").removeAttr("style");
		$("#cancelBtn").removeAttr("style");
    });
    
    // 수정 취소 -> 조회 모드로 다시 전환
    $("#cancelBtn").on("click", function() {
		$(".form-control").prop("readonly", true);
		$("#updateLabel").attr("style", "display: none;");
		$("#updateBtn").attr("type", "button");
		$("#updateProfileBtn").attr("style", "display: none;");
		$("#cancelBtn").attr("style", "display: none;");
		
		$("#profileImg").attr("src", "/resources/upload/profile/${memVO.mberImage}");
		
    });
    
    // 수정하기
    $("#updateProfileBtn").on("click", function(){
    	
    	var mberId = "${memVO.mberId}";
    	var mberNm = $("#mberNm").val();
    	var password = $("#password").val();
    	var moblphonNo = $("#moblphonNo").val();
    	var mberEmail = $("#mberEmail").val();
    	var mberAdres = $("#mberAdres").val();
    	var mberImage = $("#mberImage").val();
    	
    	var formData = new FormData();
    	
    	formData.append("mberId", mberId);
    	formData.append("mberNm", mberNm);
    	formData.append("password", password);
    	formData.append("moblphonNo", moblphonNo);
    	formData.append("mberEmail", mberEmail);
    	formData.append("mberAdres", mberAdres);
    	formData.append("mberImage", mberImage);
    	
    	// 업로드한 사진 가져오기
   		formData.append("uploadFile", $("#inputImage")[0].files[0]);
    	
    	console.log("formData", formData);
    	
    	$.ajax({
    		url: "/parents/updateProfile",
    		processData: false,
    		contentType: false,
    		type:"post",
    		data:formData,
    		dataType:"json",
    		beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
    		success: function(res){
    			console.log("res -> ", res);
    	        var imgSrc = "D:\\upload\\profile\\" + res.mberImage;
    			
    			// 조회 모드로 다시 전환
    			$(".form-control").prop("readonly", true);
    			$("#updateLabel").attr("style", "display: none;");
    			$("#updateBtn").attr("type", "button");
    			$("#updateProfileBtn").attr("style", "display: none;");
    			$("#cancelBtn").attr("style", "display: none;");
    			
//     			setTimeout(function(){
// 	    			$("#profileImg").attr("src", imgSrc);
//     			}, 5000);
    		}
    	});
    });
    
});
</script>
<%-- <p>학부모 정보: ${memVO}</p> --%>
<%-- <p>자녀 리스트1: ${childList[0].schulVOList[0]}</p> --%>
<%-- <p>회원 이미지: ${memVO.mberImage}</p> --%>
<div id="FreeBoardContainer">
	<form method="post" action="/freeBoard/download" id="freeUploadFrm">
		<input type="hidden" value="" name="atchFileCode" id="atchFileCode">
		<input type="hidden" value="" name="atchFileSn" id="atchFileSn">
		<sec:csrfInput />
	</form>
	<form method="post" action="/freeBoard/updateFreeBoard" id="freeUpdateFrm">
		<input type="hidden" value="" name="atchFileCode" id="atchFileCode3">
		<input type="hidden" value="" name="nttCode" id="nttCode2">
		<input type="hidden" value="" name="nttNm" id="nttNm2">
		<input type="hidden" value="" name="nttCn" id="nttCn2">
		<sec:csrfInput />
	</form>
	<h4>
		<img src="/resources/images/classRoom/task/taskCheck.png" style="width:50px; display:inline-block; vertical-align:middel;">
			마이 페이지
		<img src="/resources/images/classRoom/task/pencil.png" style="width:50px; display:inline-block; vertical-align:middel;">		
	</h4>
<%-- 		<p>${USER_INFO.mberId}</p> --%>
	<div class="FreeBoardAll" style="width: 1250px; margin: auto; margin-bottom:50px;">
		<div class="row">
			<div class="product-payment-inner-st">
				<ul id="myTabedu1" class="tab-review-design">
					<li class="active"><a href="#description">내 정보</a></li>
				</ul>
				<div id="myTabContent" class="tab-content custom-product-edit">
					<div class="product-tab-list tab-pane fade active in" id="description">
						<div class="row">
							<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
								<div class="library-book-area mg-t-30">
									<div class="container-fluid">
										<div class="row">
											<div class="col-lg-4 col-md-6 col-sm-6 col-xs-12">
												<div class="single-cards-item">
													<div class="profile-img" style="text-align: center;">
														<img id="profileImg"
															src="/upload/profile/<%=memVO.getMberImage()%>" alt="">
													</div>
													<div class="profile-details-hr">
														<div class="row" style="text-align: center;"></div>
													</div>
												</div>
											</div>
											<div class="col-lg-4 col-md-6 col-sm-6 col-xs-12">
												<div class="single-product-text">
													<div class="devit-card-custom">
														<div class="form-group">
															<p>
																이름 <input id="mberNm" name="mberNm" type="text"
																	class="form-control" value="${memVO.mberNm}" readonly>
															</p>
														</div>
														<div class="form-group">
															<p>
																핸드폰번호 <input id="moblphonNo" name="moblphonNo"
																	type="text" class="form-control" value="${memVO.moblphonNo}" readonly>
															</p>
														</div>
														<div class="form-group">
															<p>
																이메일 <input id="mberEmail" name="mberEmail" type="text"
																	class="form-control" value="${memVO.mberEmail}" readonly>
															</p>
														</div>
														<div class="form-group">
															<p>
																주소 <input id="mberAdres" name="mberAdres" type="text"
																	class="form-control" value="${memVO.mberAdres}" readonly>
															</p>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="row">
								    <div class="col-lg-12">
								       <div class="payment-adress">
								       <label for="inputImage" id="updateLabel" style="display: none;"
								         class="btn btn-primary waves-effect waves-light">
								         <input type="file" accept="image/*" name="uploadFile" id="inputImage" class="hide" />사진 업로드
								      </label>
								      <input type="hidden" name="mberImage" id="mberImage" value="">
								      <input type="button" id="updateBtn" class="btn btn-primary waves-effect waves-light" value="수정">
								      <input type="button" id="updateProfileBtn" class="btn btn-primary waves-effect waves-light"
								      	value="확인" style="display: none;">
								      <input type="button" id="cancelBtn" class="btn btn-primary waves-effect waves-light"
								      	value="취소" style="display: none;">
								      </div>
								   </div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
	
<div class="FreeBoardAll" style="width: 1250px; margin: auto; margin-bottom:50px;">
			<div class="row">
				<div class="product-payment-inner-st">
					<ul id="myTabedu1" class="tab-review-design">
						<li class="active"><a href="#description">자녀 정보</a></li>
					</ul>
					<div id="myTabContent" class="tab-content custom-product-edit">
				<div class="product-tab-list tab-pane fade active in" id="description">
					<form action="/student/updateInfo" method="post" enctype="multipart/form-data">
					<div class="row">
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
							<div class="product-status-wrap drp-lst">
								<div class="asset-inner">
									<table>
										<tbody id="childInfoTbody">
											<tr>
												<th>번호</th>
												<th>프로필</th>
												<th>이름</th>
												<th>이메일</th>
												<th>전화번호</th>
												<th>소속 학교</th>
												<th>학년</th>
												<th>소속 클래스</th>
												<th>가족 관계</th>
											</tr>
<%-- 											<p>자녀 리스트1: ${childList[0].schulVOList[0].schulPsitnMberVO.memberVO}</p> --%>
											<c:forEach var="child" items="${childList}" varStatus="status">
												<tr>
													<td>1</td>
													<td><img id="childImage"
													src="/upload/profile/${child.schulVOList[0].schulPsitnMberVO.memberVO.mberImage}" alt=""></td>
													<td>${child.schulVOList[0].schulPsitnMberVO.memberVO.mberNm}</td>
													<td>${child.schulVOList[0].schulPsitnMberVO.memberVO.mberEmail}</td>
													<td>${child.schulVOList[0].schulPsitnMberVO.memberVO.moblphonNo}</td>
													<td>${child.schulVOList[0].schulNm}</td> <!-- 학교 -->
													<td>${child.schulVOList[0].clasVO.cmmnGradeNo}</td> <!-- 클래스 -->
													<td>${child.schulVOList[0].clasVO.clasNm}</td> <!-- 클래스 -->
													<td>${child.familyRelateNm}</td>
												</tr>
											</c:forEach>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>


<!-- ///////////////////////// modal -->
<form id="updatePasswordForm" action="/student/updatePassword" method="post">
	<div id="UpdatePasswordModal"
		class="modal modal-edu-general default-popup-PrimaryModal fade"
		role="dialog">

		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-close-area modal-close-df">
					<a class="close" data-dismiss="modal" href="#"> <i
						class="fa fa-close"></i></a>
				</div>
				<div class="modal-body">
					<div>
					<h2>비밀번호 변경</h2>
					<span id="firstPwChk" style="display: none;">*최초 1회 비밀번호 변경이 필요합니다.</span>
					</div>
					<br>
					<div id="pwChk" class="alert alert-danger alert-mg-b" role="alert" style="display: none;">
						
					</div>
					<div id="UpdatePasswordContainer">
						<ul class="InputPassword">
							<li><span>비밀번호</span> <input type="password" name="password"
								id="password1" class="form-control"> <small
								data-chk="dataChk">특수기호/영문가능</small></li>
							<br>
							<li><span>비밀번호 확인</span> <input type="password"
								name="password2" id="password2" class="form-control"> <small
								data-chk="dataChk">동일한 비밀번호를 입력해주세요</small></li>
						</ul>
					</div>
				</div>
				<div class="modal-footer">
					<a id="UpdatePasswordBtn" href="#">수정</a>
					<a data-dismiss="modal" href="#">취소</a>
				</div>
			</div>
		</div>
	</div>
</form>