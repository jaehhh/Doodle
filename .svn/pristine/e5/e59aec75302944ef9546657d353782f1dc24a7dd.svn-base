<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<style>
#clasInNo {
	border: 2px solid #bbb;
    border-radius: 5px; /* 둥근 테두리 설정 */
    font-size: 15px; /* 원하는 크기로 설정 */
    padding: 10px; /* 텍스트 입력란의 내부 여백 설정 */
    width: 50px; /* 입력 필드의 너비 설정 */
}

/* Chrome, Safari, Edge, Opera input 숫자 화살표 없애기*/
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox  input 숫자 화살표 없애기*/
input[type='number'] {
  -moz-appearance: textfield;
}

.pagination {
    display: flex;
    padding-left: 0;
    margin: 20px 0;
    border-radius: 4px;
}

.modal-dialog {
    max-width: 500px;
}

.modal-body h4,
.modal-body p,
.modal-footer {
    text-align: center;
}

.modal-body h4 {
    margin-top: 20px; /* 상단 여백 설정 */
}

.modal-area-button .Primary { /* 신청버튼 */
    background: #006DF0;
    font-size: 14px;
    padding: 8px 15px;
    border-radius: 3px;
}

.modal-area-button .mg-b-10 {
    margin-top: 0px;
}

.modal-area-button .danger-color {/* 종료버튼 */
    background: #eaeaea;
    padding: 8px 15px;
}

.table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
    padding: 2px;
    line-height: 1.42857143;
    vertical-align: middle;
    border-top: 1px solid #ddd;
}

h3#title{
	font-size: 2.2rem;
	text-align: center;
	margin-top: 60px;
	backdrop-filter: blur(4px);
	background-color: rgba(255, 255, 255, 1);
	border-radius: 50px;
	box-shadow: 35px 35px 68px 0px rgba(145, 192, 255, 0.5), inset -8px -8px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
	width: 370px;
	padding-top: 35px;
	padding-bottom: 35px;
	margin: auto;
	margin-top: 50px;
	margin-bottom: 40px;
}

.h3, h3 {
    font-size: 30px;
}

.modal-edu-general .modal-body p {
    line-height: 24px;
    font-size: 16px;
    font-weight: 400;
    padding: 15px;
}

.invCode:focus {
	outline:none;
}
  
#invCodeJoinModal input.invCode {
    font-family: inherit;
    font-size: 100%;
    line-height: 1.15;
    font-size: 40px;
    width: 300px;
    letter-spacing: 6.2px;
    /* 다른 스타일 속성들 */
}
	

#invCodeJoinModal p {
    line-height: 24px;
    font-size: 35px;
    font-weight: 400;
    margin-top: -25px;
    /* 다른 스타일 속성들 */
}



</style>
<script>
//전역 변수
var currentPage = "${param.currentPage}";
var keyword = "";
var schulCode = "${param.schulCode}";
var cmmnClasSttusNm = "전체";
var clasCode = "";

$(function(){
	//console.log("존재:",$("#btnSearch")[0]);
	console.log("keyword",keyword);
	currentPage = "1";
	//기본조회
	fn_search(1);
	
	//input태그에서 엔터시 검색버튼누르기
	var input = $("#keyword");
	  input.on("keypress", function(event) {
	      if (event.key === "Enter") {
	          event.preventDefault();
	          $("#btnSearch").click();
	      }
	  });
	
	//검색조회
	$("#btnSearch").on("click",function(){
		fn_search(1);
	}); //검색 끝
		
	//상태 선택조회
    $("#cmmnClasSttusNm").change(function() {
    	 //cmmnClasSttusNm = $(this).val(); //선택된 값으로 상태 업데이트
//	      $("#classListBody").html(""); //목록 초기화 */
    	  fn_search(1);
    });//셀렉트끝



	//모달---------------- 

	//가입완료버튼 -> 클래스 코드 가져오기
	$(document).on('click', '#joinChk', function() {
	    clasCode = $(this).data('clas-code');
	    console.log("clasCode:", clasCode);
	});
    
	$("#joinBtn").on("click",function(){
		console.log("clasCode",clasCode);
		console.log("내가 가져온 값들 ->", clasCode + "랑 " + schulCode);
		
		let clasInNo = $("#clasInNo").val(); //학급 번호

		// 학생 번호 입력 체크 - sweetAlert2사용
		if (!clasInNo.trim()) { 
			  Swal.fire({
				  icon : "error",
			      title: "번호를 입력해주세요 !"
			    })
			return;
		}
		
		let data = {
				"schulCode":schulCode,
				"clasInNo":clasInNo,
				"clasCode":clasCode
		}
		console.log("data",data);
		
		//클래스 가입 ajax
		$.ajax({
			url:"/class/classJoinReqAjax",
			contentType:"application/json;charset=utf-8",
			data:JSON.stringify(data),
			type:"post",
			dataType:"text",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},success:function(result){
				console.log("result",result);
				//result=0 실패 / result=1성공
				if(result =="0"){
					Swal.fire({
						title: '이미 가입신청 한 클래스입니다.',
						text: '가입신청을 취소할까요?',
						icon: 'warning',
						
						showCancelButton: true, // cancel버튼 보이기. 기본은 원래 없음
						confirmButtonColor: '#3085d6', // confrim 버튼 색깔 지정
						cancelButtonColor: '#d33', // cancel 버튼 색깔 지정
						confirmButtonText: '승인', // confirm 버튼 텍스트 지정
						cancelButtonText: '취소', // cancel 버튼 텍스트 지정
						}).then(result => {
						// 만약 Promise리턴을 받으면,
						if (result.isConfirmed) { // 만약 모달창에서 confirm 버튼을 눌렀다면
						
							let data = {
									"schulCode":schulCode,	//학교코드
									"clasCode":clasCode		//클래스코드
							}
							$.ajax({
								url:"/class/classJoinReqCancelAajx",
								contentType:"application/json;charset=utf-8",
								data:JSON.stringify(data),
								type:"post",
								dataType:"text",
								beforeSend:function(xhr){
									xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
								},success:function(result){
									console.log("1이면 삭제성공! >> ",result);
								}
							}); //DELETE AJAX 끝
								Swal.fire({
								title: '가입신청을 취소했습니다.',
								icon: 'success'
								})
							$("#classroomJoinChekModal").modal('hide'); //모달 닫기
						}
					});
				}else if(result=="1"){
					Swal.fire({
						icon : "success",
						title: "가입신청이 완료되었습니다."
			    		}).then(() => {
							$("#classroomJoinChekModal").modal('hide'); //모달 닫기
						});
				}
			}//success끝
		}); //가입 ajax끝
	}); //가입버튼 끝
	//등록버튼
	$("#createBtn").on("click", function() {
			location.href = "/class/classCreate?schulCode="+schulCode; //GET방식
		});
});

//초대코드 가입하기 모달
$(document).on('click', '#invCodeBtn', function() {

	$('#classroomJoinChekModal').modal('hide');
});
//초대코드모달 -> 완료
$(document).on('click', '#invCodeChkBtn', function() {

	var invCode = $(".invCode").val();
	console.log("invCode",invCode);
	console.log("clasCode",clasCode);

	if(!invCode || invCode === null || invCode.trim() === ""){
		Swal.fire({
					icon : "warning",
					title: "초대코드를 입력해주세요"
				});
		return;
	}

	//학교 소속회원에 INSERT
	if(clasCode == invCode){

		let data = {
			"schulCode":schulCode,
			"clasCode":clasCode
		}
		console.log("schulCode",schulCode);

		$.ajax({
			type:"post",
			url:"/class/classInvCodeJoin",
			contentType:"application/json;charset=utf-8",
			data:JSON.stringify(data),
			dataType:"json",
			beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},success:function(result){
				if(result == 0){
					Swal.fire({
						icon : "error",
						title: "이미 소속된 클래스입니다."
					});
				}else{
					Swal.fire({
						icon : "success",
						title: "가입이 완료되었습니다."
					});
					// 클래스로 이동하는 경로 location.href = "/class/classCreate?schulCode="+schulCode; //GET방식
				}
			}

		})//Ajax 끝

		
	}else{
		Swal.fire({
					icon : "error",
					title: "초대코드를 확인해주세요."
			    });
		return;
	} //if문 끝
});//완료버튼끝



    //모달 ------------------

//기본조회함수
function fn_search(page) {
	var keyword = $("#keyword").val();
    var data = {
			"schulCode": schulCode,
			"keyword" : keyword,
    		"currentPage" : page,
    		"cmmnClasSttusNm" : $("#cmmnClasSttusNm").val()
    }
    console.log("data : ",data);
    $("#classListBody").html(""); //목록 초기화
    $.ajax({
		url:"/class/classListAjax",
		type:"post",
		data:JSON.stringify(data), //현재 페이지 전달
		contentType:"application/json;charset=utf-8",
		dataType:"json",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success:function(result){
			/* console.log("result.pagingArea", result.pagingArea); */
			console.log("result!!",result);
            if (result.total == 0) {
                $("#keyword").val('');

                var str = "<tr>";
                str += "<td colspan='7' style='text-align: center;font-size: 2.0rem;'>" + keyword + "에 대한 검색 결과가 없습니다</td>";
                str += "</tr>";
                
                $("#classListBody").html(str);
            } else {
                var str = ""; // 결과를 누적하기 위해 빈 문자열로 초기화
				
				$.each(result.content, function(idx, clasVO) {
					console.log("clasVO[" + idx + "] : ", clasVO);
				str += "<tr>";
					str += "<td>" + clasVO.rnum + "</td>";
					str += "<td>" + clasVO.clasYear + "</td>";
					str += "<td>" + clasVO.schulNm + "</td>";
					str += "<td>" + clasVO.cmmnGradeNm+"학년\t"+clasVO.clasNm+ "</td>";
					str += "<td>" + clasVO.cmmnClasSttusNm + "</td>";
					str += "<td>";
						if (clasVO.cmmnClasSttusNm === '운영') {
							str += "<div class='modal-area-button'><a class='Primary mg-b-10' href='#classroomJoinChekModal' data-toggle='modal' data-clas-code='" + clasVO.clasCode + "' data-schul-code='" + clasVO.schulCode + "' id='joinChk'>신청</a></div>";
						}else if(clasVO.cmmnClasSttusNm === '중지' || clasVO.cmmnClasSttusNm === '종료'){
							str += "<div class='modal-area-button'><a class='Danger danger-color' href='#errorBtn' data-toggle='modal'>종료</a></div>";
						}
					str += "</td>";
					str += "</tr>";
				
				});

				//누적!
				$("#classListBody").append(str);
			}
			//페이징처리
			$("#divPaging").html(result.pagingArea);
		 
		},
		error: function(xhr, status, error) {
	            console.error(status, error);
	        }
	}); //ajax끝
}
    
</script>
<div class="sparkline8-list">
	<div class="sparkline8-hd">
		<div class="main-sparkline8-hd">
			<h3 id="title">
			<img src="/resources/images/classRoom/classList1.png" style="width:50px; display:inline-block; vertical-align:middel;">
				학급 클래스 목록
			<img src="/resources/images/classRoom/classList2.png" style="width:50px; display:inline-block; vertical-align:middel;">		
		</h3>
		</div>
	</div>
	<div class="row">
		<!-- 등록 버튼 시작 -->
		<div class="col-md-10 text-right">
			<!-- text-right를 사용하여 오른쪽 정렬 -->
			<button type="button" id="createBtn" class="btn btn-custon-rounded-two btn-primary">등록</button>
		</div>
		<!-- 등록 버튼 끝 -->
		<!-- 검색 셀렉트 -->
		<div class="col-md-2 text-right">
		    <select class="form-control" id="cmmnClasSttusNm">
		        <option value="전체">전체</option>
		        <option value="운영">운영</option>
		        <option value="중지">중지</option>
		        <option value="종료">종료</option>
		    </select>
		</div>
		<!-- 검색 셀렉트 -->
		<!-- 검색 -->
		<div class="col-md-2 text-right">
			<!-- text-right를 사용하여 오른쪽 정렬 -->
			<div class="breadcome-heading">
				<form role="search" class="sr-input-func">
					<input type="text" name="keyword" id="keyword" placeholder="Search..."
						class="search-int form-control"> <a href="#" id="btnSearch"><i
						class="fa fa-search"></i></a>
				</form>
			</div>
		</div>
		<!-- 검색 끝 -->
	</div>
	<div class="sparkline8-graph">
		<div class="static-table-list modal-area-button">
			<table class="table">
				<thead>
					<tr>
						<th>순번</th>
						<th>연도</th>
						<th>학교</th>
						<th>반이름</th>
						<th>상태</th>
						<th>가입신청</th>
					</tr>
				</thead>
				<tbody id="classListBody">
					
				</tbody>
			</table>
		</div>
	</div>
	<div class="pull-right pagination" id="divPaging"></div>
</div>

<!--학생 클래스 가입 모달 시작-->
<div id="classroomJoinChekModal" class="modal modal-edu-general default-popup-PrimaryModal fade in" role="dialog" style="display: none; padding-right: 17px;">
	<div class="modal-dialog" >
		<div class="modal-content">
			<div class="modal-close-area modal-close-df">
				<a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
			</div>
			<div class="modal-body">
				<h3>클래스 가입 요청</h3>
				<p>교실에서 나는&nbsp;<input type="number" id="clasInNo" placeholder="99" required />&nbsp;번 입니다</p>
				<span style="font-weight: bold; cursor: pointer;" id="invCodeBtn" data-toggle="modal" data-target="#invCodeJoinModal">초대코드로 가입하기</span>
			</div>
			<div class="modal-footer">
				<a href="#" id="joinBtn">완료</a>
				<a data-dismiss="modal" href="#">취소</a>
			</div>
		</div>
	</div>
</div>
<!--학생 클래스 가입 모달 끝-->


<!--학부모 클래스 가입 모달 시작-->
<div id="invCodeJoinModal" class="modal modal-edu-general default-popup-PrimaryModal fade in" role="dialog" style="display: none; padding-right: 17px;">
	<div class="modal-dialog" >
		<div class="modal-content">
			<div class="modal-close-area modal-close-df">
				<a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
			</div>
			<div class="modal-body">
				<h3>초대코드 입력</h3>
				<input class="invCode" type="text" style="border: none;" maxlength="10">
				<p id="guideText">ㅡㅡㅡㅡㅡㅡㅡㅡ</p>
				
			</div>
			<div class="modal-footer">
				<a href="#" id="invCodeChkBtn">완료</a>
				<a data-dismiss="modal" href="#">취소</a>
			</div>
		</div>
	</div>
</div>
<!--학부모 클래스 가입 모달 끝-->

<!-- 종료 클래스 가입 모달 시작 -->
<div id="errorBtn" class="modal modal-edu-general default-popup-PrimaryModal fade in" role="dialog" style="display: none; padding-right: 17px;">
	<div class="modal-dialog" >
		<div class="modal-content">
			<div class="modal-close-area modal-close-df">
				<a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
			</div>
			<div class="modal-body">
				<h4>가입할 수 없는 상태의 클래스입니다.</h4>
			</div>
			<div class="modal-footer">
				<a data-dismiss="modal" href="#">확인</a>
			</div>
		</div>
	</div>
</div>
<!-- 종료 클래스 가입 모달 끝 -->

