<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<style>
.__se_tbl{
	width: 100%;
}

.__se_tbl td{
	border: 1px solid rgb(232 232 232);
	padding: 5px;
	font-size: 17px;
	
}
.__se_tbl tr{
/*  	font-weight: bold; */
}

p{
	margin: 0px;
}

#ntcnTitle h3{
font-size: 2.2rem;
text-align: center;
backdrop-filter: blur(4px);
background-color: rgba(255, 255, 255, 1);
border-radius: 50px;
box-shadow: 35px 35px 68px 0px rgba(145, 192, 255, 0.5), inset -8px -8px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
width: 370px;
padding-top: 35px;
padding-bottom: 35px;
margin: auto;
margin-bottom: 40px;
}

</style>
<style>
#ntcnSj{
	width:95%;
	border:none;
	background: none;
	height: 50px;
	font-size: 1.4rem;
	display: inline-block;
	vertical-align: middle;
	margin-bottom:6px;
}

.ntcnImg{
	width: 300px;
	height: 300px;
	object-fit: cover;
}

.ntcnIcon{
	width: 12px;
	margin-top: 3.5px;
	margin-right: 3px;
	vertical-align: top;
	display: inline-block;
}

#fixingIcon{
	position: absolute;
	left: -4px;
	top: -13px;
	z-index: -1;
	width:50px;
}

#ntcnTitle{
	min-height: 255px;
    width: 1400px;
    margin: auto;
}

#ntcnContainer{
	min-height: 255px;
}

#ntcnContainer .custom-pagination{
	max-width:302px;
	margin: auto;
}
#ntcnContainer .custom-pagination .pagination {
	 width: max-content;
}
.searchForm{
	height: 40px;
	border: 1px solid #ddd;
	border-radius: 5px;
	padding: 15px 20px;
}

#searchBtn,#insertBtn,#goToListBtn{
	background: #333;
	height: 40px;
	border: none;
	padding: 10px 15px;
	border-radius: 10px;
	font-family: 'Pretendard' !important;
	font-weight: 600;
	color: #fff;
}
#searchBtn:hover, #insertBtn:hover, #goToListBtn:hover{
	background: #ffd77a;
	color:#333;
	transition:all 1s;
	font-weight: 700;
}
#goToListBtn{
	background: #666;
}
#updateBtn,#fixBtn,#deleteBtn{
	border: none;
	color: #fff;
	border-radius: 10px;
	padding: 10px 10px;
}
#insertBtn, #updateBtn{
	background: #006DF0;
}
#deleteBtn{
	margin-left: 7px;
	margin-right: 7px;
	background: #666;
}
#fixBtn{
	background: #333;
}
#searchCondition{
	height: 40px;
	border: 1px solid #ddd;
	border-radius: 5px;
	padding-left: 10px;
}

.custom-datatable-overright table tbody tr.none-tr td:hover{
	background: #fff!imporant;
}

.ntcnAll{
	width: 1400px;
	margin: auto;
	backdrop-filter: blur(10px);
	background-color: rgba(255, 255, 255, 1);
	border-radius: 50px;
	box-shadow: 0px 35px 68px 0px rgba(145, 192, 255, 0.5), inset 0px -6px 16px 0px rgba(145, 192, 255, 0.6), inset 0px 11px 28px 0px rgb(255, 255, 255);
	padding: 50px 80px;
	margin-bottom:50px;
	min-height:430px;"
}

.ntcnAll .ntcn-cont{
	border: 1px solid #ddd;
	border-radius: 10px;
	padding: 50px;
	min-height: 83px;
	margin-top: 20px;
	margin-bottom: 60px;
}
.ntcnAll .ntcnTit {
	display: flex;
	justify-content: space-between;
	position:relative;
}

.ntcnAll .title{
	font-size: 1.8rem;
	font-weight: 700;
	margin-top: 6px;

}
.ntcnInfo {
	display: flex;
	justify-content: space-between;
	margin-top: 15px;
	font-size: 1rem;
}

#ntcnCn{
	resize: none;
	height: auto;
	border: none;
}

</style>
<script type="text/javascript" src="/resources/js/commonFunction.js"></script>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<script type="text/javascript">
// 전역 변수
// var ntcnVOList = "${ntcnVOList}";
// var atchFileVOList = "${atchFileVOList}"
var keyword = "${keyword}";
var clasCode = "${clasCode}";
var total = "${total}";
var ntcnSj = "";
var str = "";
var length = "" // 알림장 목록의 길이를 담는 변수

function fn_ntcnList(paramPage){
	var data = {
		"clasCode":clasCode,
		"currentPage":paramPage,
		"keyword":keyword
	};
	
	// 알림장 목록 불러오기
	$.ajax({
		url:"/ntcn/ntcnListAjax",
		contentType:"application/json;charset=utf-8",
		data:JSON.stringify(data),
		type:"post",
		dataType:"json",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success: function(res){
			console.log("ntcnList : ", res);
			length = res.length;
			
			$.each(res, function(idx, ntcnVO){
				str += "<div class='ntcnAll'><div>";
				
				// 로그인한 회원이 담임 교사인 경우, 수정 버튼 추가
				if("${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode}" == 'ROLE_A14002'){
					str += "<div style='display: flex; justify-content: flex-end;'>";
					str += "<input type='submit' id='updateBtn' value='수정'>";
					str += "<input type='button' id='deleteBtn' value='삭제'>";
					
					var fixBtnValue = (ntcnVO.imprtcNtcnAt == 0) ? "중요 알림 설정" : "중요 알림 해제";
					str += "<input type='button' id='fixBtn' value='"+fixBtnValue+"'></div>";
				}
				
				// 중요 알림인 경우, 고정 아이콘 추가
				if(ntcnVO.imprtcNtcnAt == 1){
					str += "<img id='fixingIcon' src='/resources/images/classRoom/notice/fixing.png'>";
				}
				
				str += "<div class='ntcnTit'>";
				str += "<input type='text' class='form-control input-sm' name='ntcnSj' id='ntcnSj' value='"+ntcnVO.ntcnSj+"' data-ntcnSj='"+ntcnVO.ntcnSj+"' readonly>";
				str += "<input type='hidden' id='ntcnCode' value='"+ntcnVO.ntcnCode+"' readonly>";
				str += "<input type='hidden' id='atchFileCode' value='"+ntcnVO.atchFileCode+"' readonly>";
				str += "<img src='/resources/images/classRoom/freeBrd/line.png' style='position: absolute;left: 0px;top: 10px;z-index: -1;'>";
				str += "</div><div class='ntcnInfo'>";
				
				str += "<span style='margin-left:12px; font-size: 13px;'>";
				str += "<img class='ntcnIcon' src='/resources/images/classRoom/freeBrd/freePersonIcon.png' alt='알림장 작성자 아이디 아이콘'/>";
				str += "<small style='font-weight: 600;color: #222;font-size: 13px; line-height: 1.75;'>작성자 : </small>";
				str += "<span style='color:#666; font-size: 13px;'>"+ntcnVO.hrtchrVO.mberNm+"</span>";
				str += "</span>";
				
				str += "<span style='margin-left:12px; font-size: 14px;'>";
				str += "<img class='ntcnIcon' src='/resources/images/classRoom/freeBrd/freeDateIcon.png' alt='알림장 등록일자 아이콘'/>";
				str += "<small style='font-weight: 600;color: #222;font-size: 13px;'>등록일자 : </small>";
				str += "<span style='color:#666; font-size: 13px;'>"+dateFormat(ntcnVO.ntcnWritngDt)+"</span>";
				str += "</span>";
				
				str += "</div></div>";
				str += "<div class='form-group res-mg-t-15'>";
				str += "<div class='ntcn-cont'>";
				str += "<div id='smarteditor'>";
				str += "<div id='ntcnCnDiv' style='width:100%;' style='border:1px solid #ddd;'>";
				str += "<div id='ntcnCn' name='ntcnCn' readonly>"+ntcnVO.ntcnCn+"</div>"

				$("#ntcnCn").html(ntcnVO.ntcnCn);

				
				str += "<div id='imgDiv'>";
				
				// 첨부파일이 있는 경우 첨부파일 리스트 출력
				if(ntcnVO.atchFileVO != null){
					$.each(ntcnVO.atchFileVO,function(idx2,atchFileVO){
						str += "<img class='ntcnImg' alt='알림장 이미지' src='/upload/ntcn/" + atchFileVO.atchFileCours + "' data-atchFileCode='"+atchFileVO.atchFileCode+"' data-atchFileCours='"+atchFileVO.atchFileCours+"'>";
						var imgTag = $("<img>").attr("src", "/upload/ntcn/" + atchFileVO.atchFileCours).attr("alt", "알림장 이미지");
                        $("#imgDiv").html(imgTag);
					});
							
				}//end if
				str += "</div></div></div></div></div></div>";
			});//end each
			$("#ntcnContainer").html(str);
		}
	});//end ajax
}//end fn_ntcnList

$(function(){
	let currentPage = 1;
// 	let isLoading = false;

	// 알림장 목록 불러오기
	fn_ntcnList(1);
	
	// 무한 스크롤
	$(window).on("scroll", function(e){
		let scrollTop = $(window).scrollTop(); // 스크롤 된 길이
		let windowHeight = $(window).height(); // 웹 브라우저의 창의 높이
		let documentHeight = $(document).height(); // 문서 전체의 높이
		let isBottom = scrollTop + windowHeight + 10 >= documentHeight; // 바닥까지 스크롤 되었는지 여부
		
		if(isBottom){
			// 현재 마지막 페이지거나 알림장 리스트가 한 페이지에 출력될 수(5)보다 작은 경우,
			if(currentPage > (total/5) || length < 5){
				return;
			}else{
				currentPage++;
// 				alert("currentPage : " + currentPage);
				
				fn_ntcnList(currentPage);
			}
		}
	});

	// 알림 등록
	$("#insertBtn").on("click", function(){
		location.href = "/ntcn/ntcnInsertForm?clasCode="+clasCode;
	});
	
	// 알림장 이미지 크게 보기
	$(document).on("click", ".ntcnImg", function(){
		$("#ntcnImgViewer").modal("show");
		
		var atchFileCode = $(this).attr("data-atchFileCode");
		var atchFileCours = $(this).attr("data-atchFileCours");

		var imgTag = $("<img>").attr("src", "/upload/ntcn/"+atchFileCours);
		$("#ntcnImgContainer").html(imgTag);
	});
	
	// 알림장 수정 폼 띄우기
	$(document).on("click", "#updateBtn", function(){
		var ntcnCode = $(this).closest('.ntcnAll').find("#ntcnCode").val();
		location.href = "/ntcn/ntcnUpdateForm?ntcnCode=" + ntcnCode;
	});
	
	// 중요한 알림 설정/해제
	$(document).on("click", "#fixBtn", function(){
		var fixVal = $(this).closest(".ntcnAll").find("#fixBtn").val();
		var ntcnCode = $(this).closest(".ntcnAll").find("#ntcnCode").val();
		var ntcnSj = $(this).closest(".ntcnAll").find("#ntcnSj").val();
		var imprtcNtcnAt = 1;
 		var title = "";

 		if(fixVal == "고정 해제"){
			imprtcNtcnAt = 0;
			title = "["+ntcnSj+"]의 중요 알림 설정을 해제하시겠습니까?";
		}else{
			title = "["+ntcnSj+"]을/를 \n중요 알림으로 설정하시겠습니까?";
		}
 		
	 	Swal.fire({
			title: title,
			icon: 'warning',
			showCancelButton: true,       	// cancel 버튼 보이기
			confirmButtonText: '설정',       // confirm 버튼 텍스트 지정
			cancelButtonText: '취소',        // cancel 버튼 텍스트 지정
		}).then(result => {
	        // confirm 버튼을 눌렀을 경우,
	        if(result.isConfirmed){
            	Swal.fire('설정이 완료되었습니다.', '', 'success');
            
            	var data = {
           			"ntcnCode":ntcnCode,
           			"imprtcNtcnAt":imprtcNtcnAt
           		};
           		
           		$.ajax({
           			url:"/ntcn/updateImprtcAt",
           			data: data,
           			dataType: "text",
           			type: "post",
           			beforeSend:function(xhr){
           				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
           			},
           			success: function(res){
           				location.href = "/ntcn/ntcnList?clasCode="+clasCode;
           			}
           		})
			};
		});
	});
	
	// 알림장 게시글 삭제
	$(document).on("click", "#deleteBtn", function(){
		var ntcnCode = $(this).closest(".ntcnAll").find("#ntcnCode").val();
		var atchFileCode = $(this).closest(".ntcnAll").find("#atchFileCode").val();
		
	 	Swal.fire({
			title: "정말 삭제하시겠습니까?",
			icon: 'warning',
			showCancelButton: true,       	// cancel 버튼 보이기
			confirmButtonText: '삭제',       // confirm 버튼 텍스트 지정
			cancelButtonText: '취소',        // cancel 버튼 텍스트 지정
		}).then(result => {
	        // confirm 버튼을 눌렀을 경우,
	        if(result.isConfirmed){
	        	
            	var data = {
           			"ntcnCode":ntcnCode,
           			"atchFileCode":atchFileCode
           		};
           		
           		$.ajax({
           			url:"/ntcn/ntcnDelete",
           			data: data,
           			dataType: "text",
           			type: "post",
           			beforeSend:function(xhr){
           				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
           			},
           			success: function(res){
           			 	Swal.fire({
           					title: "삭제가 완료되었습니다.",
           					icon: 'success',
           					confirmButtonText: '확인',
           				}).then(result => {
           			        // confirm 버튼을 눌렀을 경우,
           			        if(result.isConfirmed){
           			        	location.href = "/ntcn/ntcnList?clasCode="+clasCode;
           					};
           				});
           			}
           		})
			};
		});
	});
})
</script>
<div id="ntcnTitle">
	<div class="sparkline13-list">
		<h3>
			<img src="/resources/images/classRoom/notice/noticeContent.png" style="width:50px; margin-bottom: 5px; display:inline-block; vertical-align:middel;">
				알림장
			<img src="/resources/images/classRoom/notice/star.png" style="width:40px; margin-bottom: 10px; display:inline-block; vertical-align:middel;">		
		</h3>
		<div class="sparkline13-graph">
			<div class="datatable-dashv1-list custom-datatable-overright">
				<div class="bootstrap-table">
					<div class="fixed-table-toolbar">
						<div class="pull-left button">
							<!-- 로그인한 회원이 담임 교사인 경우에만 등록 버튼 활성화 -->
							<c:if test="${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode == 'ROLE_A14002'}">
								<button type="button" id="insertBtn">알림 등록</button>
							</c:if>
							<button type="button" id="goToListBtn" onclick="location.href='/ntcn/ntcnList?clasCode=${CLASS_INFO.clasCode}'">알림 목록</button>
						</div>
						<div class="pull-right search" style="margin-bottom: 20px;">
							<form action="/ntcn/ntcnList?clasCode=${CLASS_INFO.clasCode}" method="get">
								<input class="searchForm" type="text" placeholder="" id="keyword" name="keyword" value="${keyword}">
								<input class="searchForm" type="hidden" name="clasCode" value="${CLASS_INFO.clasCode}">
								<button type="submit" id="searchBtn">검색</button>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div id="ntcnContainer">
<%--     <c:choose> --%>
<%--         <c:when test="${fn:length(ntcnVOList) > 0}"> --%>
<%--             <c:forEach var="ntchVO" items="${ntcnVOList}" varStatus="status"> --%>
<%--             	<form id="goNtcnUpdateForm" action="/ntcn/ntcnUpdateForm?clasCode=${CLASS_INFO.clasCode}" method="post"> --%>
<!--                 <div class="ntcnAll"> -->
<!--                     <div> -->
<!--                     	담임 교사만 수정 권한 부여 -->
<%--                     	<c:if test="${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode == 'ROLE_A14002'}"> --%>
<!-- 	                    	<div style="display: flex; justify-content: flex-end;"> -->
<!-- 	                    		<input type="submit" id="updateBtn" value="수정"> -->
<!-- 	                    	</div> -->
<%--                     	</c:if> --%>
<!--                         <div class="ntcnTit"> -->
<%--                             <input type="text" class="form-control input-sm" name="ntcnSj" id="ntcnSj" value="${ntchVO.ntcnSj}" readonly> --%>
<!--                             <img src="/resources/images/classRoom/freeBrd/line.png" style="position: absolute;left: 0px;top: 10px;z-index: -1;"> -->
<!--                         </div> -->
<!--                         <div class="ntcnInfo"> -->
<%--                             <span>작성자: <input type="text" class="form-control input-sm" name="ntcnSj" id="ntcnSj" value="${ntchVO.hrtchrVO.mberNm}" readonly></span> --%>
<%--                             <span>작성일: <fmt:formatDate value="${ntchVO.ntcnWritngDt}" pattern="yyyy-MM-dd" /></span> --%>
<!--                         </div> -->
<!--                     </div> -->
<!--                     <div class="form-group res-mg-t-15"> -->
<!--                         <div class="ntcn-cont"> -->
<!--                             <div id="smarteditor"> -->
<!--                                 <div id="ntcnCn" style="width:100%;" style="border:1px solid #ddd;"> -->
<%--                                     <textarea id="ntcnArea" name="ntcnArea" readonly>${ntchVO.ntcnCn}</textarea> --%>
<!--                                     <div id="imgDiv"> -->
<%--                                         <c:if test="${ntchVO.atchFileCode != null}"> --%>
<%--                                             <c:forEach var="atchFileVO" items="${atchFileVOList}" varStatus="status"> --%>
<%--                                                 <c:if test="${ntchVO.atchFileCode == atchFileVO.atchFileCode}"> --%>
<%-- <%--                                                     <a href="/upload/ntcn/${atchFileVO.atchFileCours}"> --%>
<%--                                                     	<img class="ntcnImg" src="/upload/ntcn/${atchFileVO.atchFileCours}" alt="알림장 이미지" --%>
<%--                                                     		data-atchFileCode="${atchFileVO.atchFileCode}" --%>
<%--                                                     		data-atchFileCours="${atchFileVO.atchFileCours}"> --%>
<!-- <!--                                                     </a> -->
<%--                                                 	<input type="hidden" class="cours" value="${atchFileVO.atchFileCours}"> --%>
<%--                                                 	<input type="hidden" name="atchFileCode" value="${ntchVO.atchFileCode}"> --%>
<%--                                                 </c:if> --%>
<%--                                             </c:forEach> --%>
<%--                                         </c:if> --%>
<!--                                     </div> -->
<!--                                 </div> -->
<!--                             </div> -->
<!--                         </div> -->
<!--                     </div> -->
<!--                 </div> -->
<%--                 <sec:csrfInput /> --%>
<%--                 </form> --%>
<%--             </c:forEach> --%>
<%--         </c:when> --%>
<%--         <c:otherwise> --%>
<!-- 	        <div class="ntcnAll"> -->
<!-- 				<h4 style="text-align: center"> -->
<%-- 				<c:choose> --%>
<%-- 					<c:when test="${keyword != ''}">검색 결과가 없습니다.</c:when> --%>
<%-- 					<c:otherwise>등록된 글이 없습니다.</c:otherwise> --%>
<%-- 				</c:choose> --%>
<!-- 				</h4> -->
<!-- 			</div> -->
<%--         </c:otherwise> --%>
        
<%--     </c:choose> --%>
</div>
<div id="ntcnImgViewer" class="modal modal-edu-general" role="dialog" >
	<div class="modal-content" style="width: 1200px; height: 900px;">
		<div class="modal-close-area modal-close-df">
			<a class="close" data-dismiss="modal" href="#">
			<i class="fa fa-close"></i></a>
		</div>
		<div class="modal-body" style="padding: 0px;">
			<div>
				<h2>이미지 보기</h2>
			</div>
			<br>
			<div id="ntcnImgContainer">
			
			</div>
		</div>
	</div>
</div>

