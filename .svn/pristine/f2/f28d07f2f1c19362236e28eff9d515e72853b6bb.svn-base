<%@ page language="java" contentType="text/html; charset=UTF-8"%> 
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html lang="ko" data-dark="false" class="con">
<head>
<style type="text/css">

</style>
<meta charset="utf-=8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Doodle employee List</title>
<link rel="stylesheet" href="/resources/chat/CSS/main-layout.css" />
<link rel="stylesheet" href="/resources/chat/CSS/friend.css" />
<link rel="stylesheet" href="/resources/chat/CSS/general.css" />
<link rel="preconnect" href="https://fonts.gstatic.com" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet" />
<link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
/>
<link rel="stylesheet" href="/resources/css/sweetalert2.min.css">
<script src="/resources/css/sweetalert2.min.js"></script>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<!-- sockJS -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script>
// 전역변수 설정
var socket  = null;

$(document).ready(function(){
    // 웹소켓 연결
    sock = new SockJS("<c:url value="/echo"/>");
    socket = sock;
	
    sock.onopen = function () {
        console.log('Info: connection opened.');
    };
    
 	// 데이터를 전달 받았을때 
    sock.onmessage = onMessage; // toast 생성
    
});

// toast생성 및 추가
function onMessage(evt){
    var data = evt.data;
    
    console.log("data:",data);

    var Toast = Swal.mixin({
		toast: true,
		position: 'top-end',
		showConfirmButton: true,
		timer: 5000
	});
	Toast.fire({
		icon:'info',
		title: data
	});
    
};	
</script>
<script type="text/javascript">
//모달 열고 모달에 정보넣기
function openModal(e, mberNm, mberImage, mberId, moblphonNo, mberEmail, mberAdres) {
    var modalTitle = document.querySelector('.modal-title');
    var modalBody = document.querySelector('.modal-body');

    modalTitle.textContent = mberNm; // 모달 제목 변경
//     modalBody.innerHTML = "<div>"; 
//     modalBody.innerHTML += "<img src='/upload/profile/" + mberImage + "' alt='프로필 사진' style='width: 300px; height:300px; display: block; margin: auto;'>"; // 모달 본문 변경
    modalBody.innerHTML +="<input type='text' name='friend' value='" + mberId + "' style='display:none;' />"
//     modalBody.innerHTML +="<p class='friend-info'>· 전화번호: " + moblphonNo + " </p>"
//     modalBody.innerHTML +="<p class='friend-info'>· 이메일: " + mberEmail + " </p>"
//     modalBody.innerHTML +="<p class='friend-info'>· 주소: " + mberAdres + " </p>"
//     modalBody.innerHTML += "</div>"; 
	
    if(mberImage=='null'||mberImage==''){
		$("#profileImg").attr("src", "/resources/images/member/profile/user_l.png");
	}else{
		$("#profileImg").attr("src", "/upload/profile/" + mberImage);
	}
	$("#memPh").text("☎" + moblphonNo);
	$("#memMail").text("✉" + mberEmail);
	$("#memAddr").text("🏠" + mberAdres);
	
    $('.modal').css('display', 'block');
}
        
//모달 닫기
function closeModal() {
    console.log('closeModal');
    $('.modal').css('display', 'none');
}

$(function () {
	
	//대화하기
	$("#chatting").on("click",function(){
		let myId = '${USER_INFO.mberId}';
		console.log("발신자아이디 : "+myId);
		
		let schulCode = '${param.schulCode}';
		console.log("학교코드 : "+schulCode);
		
		let friend = $('input[name="friend"]').map(function() {
		    return this.value;
		}).get().join(',');
		
		console.log("수신자아이디 : "+friend);
		
		//내가 생성한 방이 있나 확인
		let data = {
			"crtrId":friend,
   			"prtcpntId":myId
		}
		
		console.log("data@@!!",data);
		
		$.ajax({
		 	url: '/chat/roomCode',
            type: 'post',
            data: JSON.stringify(data),
            contentType: 'application/json;charset=utf-8',
            dataType: 'text',
            beforeSend: function (xhr) {
                xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
            },
            success: function (result) {
           	console.log("@생성한 채팅방 코드@",result);
           	console.log("@생성한 채팅방 코드길이@",result.length);
           	//result가 있으면 내가 생성한 방이 있으므로 생성된 방으로 이동
           	if(result !='' && result != null){
          		console.log("생성된 방으로 이동");
          		location.href = "/chat/chtt?chttRoomCode="+result;
          	}
           	 //result가 없으면 내가 초대 받은 방이 있는지확인 
           	 else{
           		 let data = {
         			"crtrId":myId,
             		"prtcpntId":friend	 
           		 }
           		 
           		$.ajax({
          			 url: '/chat/roomCode',
                       type: 'post',
                       data: JSON.stringify(data),
                       contentType: 'application/json;charset=utf-8',
                       dataType: 'text',
                       beforeSend: function (xhr) {
                           xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
                       },
                       success: function (result) {
                      	 console.log("@초대 받은 채팅방 코드@",result);
                      	//result가 있으면 내가 초대 받은 방이 있으므로 초대 받은 방으로 이동
                        if(result != '' && result != null){
                       		console.log("초대 받은 방으로 이동");
                       		location.href = "/chat/chtt?chttRoomCode="+result;
                       	}
                      	 //result가 0이면 채팅방 생성
                      	 else{
                      		let data = {
                        			"type":"room",
                        			"schulCode":schulCode,
                        			"clasCode":"",
                        			"crtrId":friend,
                        			"prtcpntId":myId
                        		}
                        		
                        		console.log("data:", data);
                        		
                        		$.ajax({
                        			 url: '/chat/room',
                                     type: 'post',
                                     data: JSON.stringify(data),
                                     contentType: 'application/json;charset=utf-8',
                                     dataType: 'json',
                                     beforeSend: function (xhr) {
                                         xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
                                     },
                                     success: function (result) {
                                    	 console.log("1?",result);
                                    	 
                                    	 $.ajax({
                                  			 url: '/chat/roomCode',
                                               type: 'post',
                                               data: JSON.stringify(data),
                                               contentType: 'application/json;charset=utf-8',
                                               dataType: 'text',
                                               beforeSend: function (xhr) {
                                                   xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
                                               },
                                               success: function (result) {
                                            	   console.log("지금 만든 채팅방 코드",result)
                                            	   //result가 있으면 내가 만든 방이 있으므로 만든 방으로 이동
                                                   if(result != '' && result != null){
                                                  		console.log("만든 방으로 이동");
                                                  		socket.send("room,"+friend+","+myId+","+result);	
                                                  		location.href = "/chat/chtt?chttRoomCode="+result;
                                                  	}
                                            	   else{
                                            		   var Toast = Swal.mixin({
                                            			   toast: true,
                                       					   position: 'top-end',
                                       					   showConfirmButton: true,
                                       					   timer: 3000
                                       				   });
                                       				   Toast.fire({
                                       					   icon:'error',
                                       					   title:'채팅방 만들기 실패'
                                       				   });
                                            		   return;
                                            	   }
                                               },
                                               error:function(xhr){
                                               	console.log("4",xhr.status);
                                               } 
                                         });
                                    	 
                                    	 
                                     },
                                     error:function(xhr){
                                     	console.log("3",xhr.status);
                                     }
                        		});
                      	 }
                      	 
                       },
                       error:function(xhr){
                       	console.log("2",xhr.status);
                       }
          			});
           		 
           	 }
           	 
            },
            error:function(xhr){
            	console.log("1",xhr.status);
            }
		});
	});
	
    // 교직원 목록
   	let data = {
        //  	"member":"${USER_INFO}",
        schulCode: '${param.schulCode}',
    };

    console.log('data', data);
    $.ajax({
        url: '/chat/friends',
        type: 'post',
        data: JSON.stringify(data),
        contentType: 'application/json;charset=utf-8',
        dataType: 'json',
        beforeSend: function (xhr) {
            xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
        },
        success: function (result) {
            //console.log(result);
            /* result : List<SchulPsitnMberVO> */
            //console.log(result[0].schulCode);

            let str = '';
            /* 설정바(최소화, 닫기 버튼 등) */
            str += "<div class='setting_bar'>";
//             str += "<i class='fa-solid fa-window-minimize' alt='최소화버튼' title='최소화'></i>";
//             str += "<i class='fa-regular fa-window-maximize' alt='최대화버튼' title='최대화'></i>";
//             str += "<i class='fa-solid fa-xmark' alt='닫기버튼' title='닫기'></i>";
            str += "</div>";
            /* 헤더: 제목, 친구 찾기 버튼, 친구 추가 버튼 */
            str += "<header>";
            str += "<div style='display: flex; justify-content: space-between;'>";
            str += "<div>";
            str += "<h1>교직원</h1>";
            str += "</div>";
            str += "<div>";
//             str += "<i class='fa-solid fa-magnifying-glass' alt='통합검색버튼' title='통합검색'></i>";
//             str += "<i class='fa-solid fa-user-plus' alt='친구추가버튼' title='친구 추가'></i>";
// 			str += "<button class='btn btn-outline-secondary' type='button' id='button-out'>나가기</button>";
            str += "</div>";
            str += "</div>";
            str += "</header>";
            /* 친구창, 대화창, 설정창 등 이동 가능한 네비게이터 */
//             str += "<nav>";
//             str += "<div class='main-menu'>";
//             str += "<a href='/chat/friends?schulCode=" + result[0].schulCode + "' id='friendList'>";
//             str += "<i class='fa-solid fa-user' alt='친구메뉴' title='친구'></i>";
//             str += "</a>";
//             str += "<a href='/chat/rooms?schulCode=" + result[0].schulCode + '&mberId='+'${USER_INFO.mberId}'+"' id = 'friend'>";
//             str += "<i class='fa-solid fa-comment' alt='채팅메뉴' title='채팅'></i>";
//             str += "<span class='alert-balloon' alt='알림수'>3</span>";
//             str += "</a>";
//             str += "<a href='/main'>";
//             str += "<i class='fa-solid fa-ellipsis' alt='더보기버튼' title='더보기'></i>";
// //             str += "<span class='alert-balloon' alt='알림수'>N</span>";
//             str += "</a>";
//             str += "</div>";
//             str += "<div class='sub-menu'>";
//             str += "<a href='temp.html' target='_blank'>";
//             str += "<i class='fa-solid fa-face-smile' alt='이모티콘샵바로가기' title='이모티콘샵'></i></a>";
//             str += "<i class='fa-solid fa-bell' alt='알림버튼' title='알림'></i>";
//             str += "<i class='fa-solid fa-gear' alt='설정버튼' title='설정'></i>";
//             str += "</div>";
//             str += "</nav>";
            /* 메인: 친구창 메인 내용 */
            str += "<main id='mainBody'>";
            str += "<div>";
            str += "<ul>";
            str += "<li>";
            if('${USER_INFO.mberImage}'==null||'${USER_INFO.mberImage}'==''){
            	str += "<img src='/resources/images/member/profile/user_l.png' alt='나의프로필사진'>";
            }else{
            	str += "<img src='/upload/profile/${USER_INFO.mberImage}' alt='나의프로필사진'>";
            }
            str += "<div class='profile'>";
            str += "<p>${USER_INFO.mberNm}</p>";
            str += "</div>";
            str += "</li>";
            str += "</ul>";
            str += "</div>";
            /* 친구 프로필 모음 */
            str += "<div>";
            str += "<div class='profile-title'>";
            str += "<h2>교직원</h2>";
            str += "<p>"+result.length+"</p>";
            str += "</div>";
            str += "<ul id='friendBody'>";
            $.each(result, function (idx, SchulPsitnMberVO) {
                //console.log("SchulPsitnMberVO["+idx+"] : ",SchulPsitnMberVO);
                console.log('SchulPsitnMberVO.memberVO', SchulPsitnMberVO.memberVO);

                str += "<li class='friend-li' onclick='openModal(this, \"" + SchulPsitnMberVO.memberVO.mberNm + "\", \"" + SchulPsitnMberVO.memberVO.mberImage + "\",\"" + SchulPsitnMberVO.memberVO.mberId + "\",\"" + SchulPsitnMberVO.memberVO.moblphonNo + "\",\"" + SchulPsitnMberVO.memberVO.mberEmail + "\",\"" + SchulPsitnMberVO.memberVO.mberAdres + "\")'>";
				if(SchulPsitnMberVO.memberVO.mberImage==null||SchulPsitnMberVO.memberVO.mberImage==''){
                	str += "<img src='/resources/images/member/profile/user_l.png' alt='나의프로필사진'>";
				}else{
                	str += "<img src='/upload/profile/" + SchulPsitnMberVO.memberVO.mberImage + "' alt='나의프로필사진'>";
				}
                str += "<p style='display:none;'>" + SchulPsitnMberVO.mberId + "</p>";
                str += "<div class='profile'>";
                str += "<p>" + SchulPsitnMberVO.memberVO.mberNm + "</p>";
                str += "<p>" + SchulPsitnMberVO.cmmnEmpClsf + "</p>";
                str += "</div>";
                str += "</li>";
            });

            str += "</ul>";
            str += "</div>";
            str += "</main>";
            str += "<aside>";
            
            str += "<div class='main-menu' style='display: flex; justify-content: space-evenly;'>";
            str += "<a href='/chat/friends?schulCode=" + result[0].schulCode + "' id='friendList'>";
            str += "<i class='fa-solid fa-user' alt='친구메뉴' title='친구'></i>";
            str += "</a>";
            str += "<a href='/chat/rooms?schulCode=" + result[0].schulCode + '&mberId='+'${USER_INFO.mberId}'+"' id = 'friend'>";
            str += "<i class='fa-solid fa-comment' alt='채팅메뉴' title='채팅'></i>";
			str += "</div>";
            str += "</aside>";
            $('#content').html(str);
            
            //나가기 클릭시 창 종료
            $("#button-out").on("click",function(){
            	window.close();
            });
        },
    });
});	
</script>
</head>
<body class="sidebar-mini sidebar-closed sidebar-collapse">
<div id="msgStack"></div>
<div id="content">

</div>
<div class="modal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content" style="border-radius: 26px;">
			<div class="modal-header" style="border-bottom: 0px;">
				<h5 class="modal-title">Modal title</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close" onclick="closeModal()" style="position: absolute; margin-left: 200px;"></button>
			</div>
			<div class="modal-body">
				<div class="profile-img" style="text-align: center;">
			        <img id="profileImg" src="" alt="">
				</div>
				<div class="single-product-text">
<!-- 				    <h4><a class="cards-hd-dn" href="#"></a></h4> -->
					<p style="margin-bottom: 2px" class="ctn-cards" id="memPh"></p>
					<p style="margin-bottom: 2px;" id="memMail"></p>
					<p style="margin-bottom: 2px;" id="memAddr"></p>
				</div>
			</div>
			<div class="modal-footer" style="border-top: 0px">
				<button type="button" class="btn btn-primary" id="chatting">대화하기</button>
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal" onclick="closeModal()">닫기</button>
			</div>
		</div>
	</div>
</div>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
	crossorigin="anonymous"></script>
</body>
</html>




						