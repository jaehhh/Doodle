<%@page import="kr.or.ddit.vo.HrtchrVO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
<style>
#profileImg{
   width: 120px; height: 120px;
   border-radius: 70%;
   object-fit: cover;
}
/* footer 위치 조절 */
/* .analytics-sparkle-area{ */
/* 	height: 1200px; */
/* } */

.content{
	display: flex;
    justify-content: center;
    align-items: center;
}

.single-product-text {
    padding: 5px;
}
.overflow-scroll {
	height: 300px;
    overflow-y: auto; /* 세로 스크롤 설정 */
}

.class-container{
	margin: 8px;
	height: 410px;
	border: 1px dashed lightgray;
	border-radius: 15px;
	background-color: white;
}
</style>
<script type="text/javascript" src="/resources/js/jquery.min.js" ></script>
<script type="text/javascript">
// 새창에서 채팅창 여는 함수
function openChatPop(url) {
    window.open(url, '_blank'
    		, 'top=140, left=0, width=500, height=1000, menubar=no, toolbar=no, location=no, directories=no, status=no, scrollbars=no, copyhistory=no, resizable=no');
}

window.onload = function() {
	//자유게시판 학급클래스 들어갈때만 보이게
	$("#studentFreeBoardLi").css("display", "block");
	$("#teacherFreeBoardLi").css("display", "block");
	$("#parentFreeBoardLi").css("display", "block");
	
	var mberImage = "${hrtchrVO.memberVO.mberImage}";
	var mberNm = "${hrtchrVO.memberVO.mberNm}";
	var moblphonNo = "${hrtchrVO.memberVO.moblphonNo}";
	var mberEmail = "${hrtchrVO.memberVO.mberEmail}";
// 	alert(mberImage);
	
	var profileImg = document.getElementById("profileImg");
	profileImg.setAttribute("src", "/upload/profile/" + mberImage);
	
	var clasCode = '${clasCode}';
	
// 	document.getElementById("goToTaskList").addEventListener("click", () => {
// 		location.href = "/task/taskList?clasCode=" + "${clasCode}";
// 	});

	//선생님과 채팅하기
	var teacherChatBtn = '${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode eq 'ROLE_A01003' }';
	console.log("teacherChatBtn : ",teacherChatBtn);
	var familyChatBtn = '${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode eq 'ROLE_A01002' || USER_INFO.vwMemberAuthVOList[1].cmmnDetailCode eq 'ROLE_A01002' }';
	console.log("familyChatBtn : ",familyChatBtn);

	if(teacherChatBtn === "true"){
		document.querySelector('#teacherChatBtn').addEventListener('click', function () {
			console.log("체크");
			let myId = '${USER_INFO.mberId}';
			console.log("발신자아이디 : "+myId);
		
			let teacherId = '${hrtchrVO.mberId}'
			console.log("수신자아이디 : "+teacherId);
		
			let schulCode = '${hrtchrVO.clasVO.schulCode}';
			console.log("학교코드 : " + schulCode);
		
			let data = {
					"crtrId":teacherId,
		   			"prtcpntId":myId
				}
				
			console.log("data@@!!",data);
		
			$.ajax({
			 	url: '/chat/roomCode',
		           type: 'post',
		           data: JSON.stringify(data),
		           contentType: 'application/json;charset=utf-8',
		           dataType: 'text',
		           beforeSend: function (xhr) {
		               xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		           },
		           success: function (result) {
		          	console.log("@생성한 채팅방 코드@",result);
		          	console.log("@생성한 채팅방 코드길이@",result.length);
		          	//result가 있으면 내가 생성한 방이 있으므로 생성된 방으로 이동
		          	if(result !='' && result != null){
		         		console.log("생성된 방으로 이동");
		         		openChatPop("/chat/chtt?chttRoomCode="+result);
		          		//location.href = "/chat/chtt?chttRoomCode="+result;
		         	}
		          	 //result가 없으면 내가 초대 받은 방이 있는지확인 
		          	 else{
		          		 let data = {
		        			"crtrId":myId,
		            		"prtcpntId":teacherId	 
		          		 }
		          		 
		          		$.ajax({
		         			 url: '/chat/roomCode',
		                      type: 'post',
		                      data: JSON.stringify(data),
		                      contentType: 'application/json;charset=utf-8',
		                      dataType: 'text',
		                      beforeSend: function (xhr) {
		                          xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		                      },
		                      success: function (result) {
		                     	 console.log("@초대 받은 채팅방 코드@",result);
		                     	//result가 있으면 내가 초대 받은 방이 있으므로 초대 받은 방으로 이동
		                       if(result != '' && result != null){
		                      		console.log("초대 받은 방으로 이동");
		                      		openChatPop("/chat/chtt?chttRoomCode="+result);
		                      		//location.href = "/chat/chtt?chttRoomCode="+result;
		                      	}
		                     	 //result가 0이면 채팅방 생성
		                     	 else{
		                     		let data = {
		                       			"type":"room",
		                       			"schulCode":"",
		                       			"clasCode":clasCode,
		                       			"crtrId":teacherId,
		                       			"prtcpntId":myId
		                       		}
		                       		
		                       		console.log("data:", data);
		                       		
		                       		$.ajax({
		                       			 url: '/chat/room',
		                                    type: 'post',
		                                    data: JSON.stringify(data),
		                                    contentType: 'application/json;charset=utf-8',
		                                    dataType: 'json',
		                                    beforeSend: function (xhr) {
		                                        xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		                                    },
		                                    success: function (result) {
		                                   	 console.log("1?",result);
		                                   	 
		                                   	 $.ajax({
		                                 			 url: '/chat/roomCode',
		                                              type: 'post',
		                                              data: JSON.stringify(data),
		                                              contentType: 'application/json;charset=utf-8',
		                                              dataType: 'text',
		                                              beforeSend: function (xhr) {
		                                                  xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
		                                              },
		                                              success: function (result) {
		                                           	   console.log("지금 만든 채팅방 코드",result)
		                                           	   //result가 있으면 내가 만든 방이 있으므로 만든 방으로 이동
		                                                  if(result != '' && result != null){
		                                                 		console.log("만든 방으로 이동");
		                                                 		socket.send("room,"+teacherId+","+myId+","+result);
		                                                 			openChatPop("/chat/chtt?chttRoomCode="+result);
		                                                 		//location.href = "/chat/chtt?chttRoomCode="+result;
		                                                 	}
		                                           	   else{
		                                           		   var Toast = Swal.mixin({
		                                           			   toast: true,
		                                      					   position: 'top-end',
		                                      					   showConfirmButton: true,
		                                      					   timer: 3000
		                                      				   });
		                                      				   Toast.fire({
		                                      					   icon:'error',
		                                      					   title:'채팅방 만들기 실패'
		                                      				   });
		                                           		   return;
		                                           	   }
		                                              },
		                                              error:function(xhr){
		                                              	console.log("4",xhr.status);
		                                              } 
		                                        });
		                                   	 
		                                   	 
		                                    },
		                                    error:function(xhr){
		                                    	console.log("3",xhr.status);
		                                    }
		                       		});
		                     	 }
		                     	 
		                      },
		                      error:function(xhr){
		                      	console.log("2",xhr.status);
		                      }
		         			});
		          		 
		          	 }
		          	 
		           },
		           error:function(xhr){
		           	console.log("1",xhr.status);
		           }
			});
		});
	}
	
	if(familyChatBtn === "true"){
		//학부모와 채팅하기
		document.querySelector('#familyChatBtn').addEventListener('click', function () {
			openChatPop('/chat/clasFam?clasCode='+clasCode);
		});
	}




}
</script>
<title></title>
</head>
<body>
<h1>클래스 메인</h1>
<p>클래스 코드: ${clasCode}</p>
<p>학교 코드: ${hrtchrVO.clasVO.schulCode}</p>
<p>담임 정보: ${hrtchrVO}</p>
<p>이미지 가져오자 -> ${hrtchrVO.memberVO.mberImage}</p>
<hr>
<%-- <% HrtchrVO hrtchrVO = (HrtchrVO) request.getAttribute("hrtchrVO"); %> --%>

<div class="courses-area mg-b-15">
    <div class="container-fluid ">
        <div class="row content">
            <div class="col-lg-3 col-md-4 col-sm-4 col-xs-12 class-container">
                <div class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
                    <div class="courses-title">
                        <h2>담임 선생님 정보</h2>
                        <hr>
                        <div class="profile-img" style="text-align: center;">
                            <img id="profileImg" src="" alt="">
                        </div>
                        <%-- <strong>${hrtchrVO.memberVO.mberNm}</strong> --%>
                    </div>
                    <div class="single-product-text">
                        <h4><a class="cards-hd-dn" href="#">${hrtchrVO.memberVO.mberNm}</a></h4>
                        <p class="ctn-cards">${hrtchrVO.clasVO.schulNm} ${hrtchrVO.clasVO.clasNm}</p>
                        <h5>☎ ${hrtchrVO.memberVO.moblphonNo}</h5>
                        <h5>✉ ${hrtchrVO.memberVO.mberEmail}</h5>
                        <c:if test="${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode eq 'ROLE_A01003' }">
                        	<a type="button" class="btn btn-primary" id="teacherChatBtn" style="color: white; ">선생님과채팅</a>
                        </c:if>
                        <c:if test="${USER_INFO.vwMemberAuthVOList[0].cmmnDetailCode eq 'ROLE_A01002' || USER_INFO.vwMemberAuthVOList[1].cmmnDetailCode eq 'ROLE_A01002' }">
                        	<a type="button" class="btn btn-primary" id="familyChatBtn" style="color: white; ">학부모와채팅</a>
                        </c:if>
                    </div>
                </div>
            </div>
            <div class="col-lg-7 col-md-6 col-sm-6 col-xs-12 class-container">
                <div class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
                    <div class="courses-title">
                        <h2>학생 리스트</h2>
                        <hr>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="padding: 0px;">
                        <div class="product-status-wrap drp-lst overflow-scroll" style="padding: 0px;">
                            <table>
                                <tbody>
                                    <tr>
                                        <th>No</th>
                                        <th>Name of Dept.</th>
                                        <th>Head</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>No. of Students</th>
                                    </tr>
                                    <tr>
									<td>1</td>
									<td>Computer</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1500</td>
								</tr>
								<tr>
									<td>2</td>
									<td>Mechanical</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1700</td>
								</tr>
								<tr>
									<td>3</td>
									<td>MBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1500</td>
								</tr>
								<tr>
									<td>4</td>
									<td>BBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1200</td>
								</tr>
								<tr>
									<td>5</td>
									<td>BBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1200</td>
								</tr>
								<tr>
									<td>6</td>
									<td>BBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1200</td>
								</tr>
								<tr>
									<td>6</td>
									<td>BBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1200</td>
								</tr>
                                    <!-- 여기에 테이블 내용 추가 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>   
    <!--  -->
    
    <div class="container-fluid ">
        <div class="row content">
            <div class="col-lg-5 col-md-4 col-sm-4 col-xs-12 class-container">
                <div class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
                    <div class="courses-title">
						<a class="follow-cards" href="/ntcn/ntcnList?clasCode=${clasCode}"
                        	id="goToNoticeList" style="position: absolute; right: 33px;">➤ 바로 가기</a>                        
                        <h2>알림장</h2>
                        <hr>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-md-6 col-sm-6 col-xs-12 class-container">
                <div class="courses-inner res-mg-t-30 table-mg-t-pro-n tb-sm-res-d-n dk-res-t-d-n">
                    <div class="courses-title">
                        <div>
                        <a class="follow-cards" href="/task/taskList?clasCode=${clasCode}"
                        	id="goToTaskList" style="position: absolute; right: 33px;">➤ 바로 가기</a>
                        <h2>과제 게시판</h2>
                        <hr>
                    </div>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="padding: 0px;">
                        <div class="product-status-wrap drp-lst overflow-scroll" style="padding: 0px;">
                            <table>
                                <tbody>
                                    <tr>
                                        <th>No</th>
                                        <th>Name of Dept.</th>
                                        <th>Head</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>No. of Students</th>
                                    </tr>
                                    <tr>
									<td>1</td>
									<td>Computer</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1500</td>
								</tr>
								<tr>
									<td>2</td>
									<td>Mechanical</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1700</td>
								</tr>
								<tr>
									<td>3</td>
									<td>MBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1500</td>
								</tr>
								<tr>
									<td>4</td>
									<td>BBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1200</td>
								</tr>
								<tr>
									<td>5</td>
									<td>BBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1200</td>
								</tr>
								<tr>
									<td>6</td>
									<td>BBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1200</td>
								</tr>
								<tr>
									<td>6</td>
									<td>BBA</td>
									<td>John Alva</td>
									<td>admin@gmail.com</td>
									<td>01962067309</td>
									<td>1200</td>
								</tr>
                                    <!-- 여기에 테이블 내용 추가 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!--  -->


</body>
</html>