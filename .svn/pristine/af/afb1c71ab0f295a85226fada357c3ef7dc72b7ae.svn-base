<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<script type="text/javascript" src="/resources/js/jquery.min.js"></script>
<script type="text/javascript" src="/resources/js/commonFunction.js"></script>

<style>
textarea {
	resize: none;
}

</style>

<script>
	window.onload = function(){
	    const addDiv = document.querySelector("#addDiv");
	}
	
	var cnt = 1; // 문항 수
    // 문항 추가
    const addQues = function(){
        cnt ++;
        let str = "";
        str += `<hr>
                
				<!-- 문제 번호 -->
				<div class="form-group-inner">
					<div class="row">
						<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
							<label class="login2 pull-right pull-right-pro">\${cnt}번 문제</label>
						</div>
						<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
						</div>
					</div>
				</div>
				
				<!-- 지문 -->
				<div class="form-group-inner">
					<div class="row">
						<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
							<label class="login2 pull-right pull-right-pro" for="quesQues\${cnt}">지문</label>
						</div>
						<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
							<textarea rows="2" class ="form-control ques" name = "quesQues\${cnt}" id ="quesQues\${cnt}"></textarea>
						</div>
					</div>
				</div>
				
				<!-- 배점 -->
				<div class="form-group-inner">
					<div class="row">
						<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
							<label class="login2 pull-right pull-right-pro" for="quesAllot\${cnt}">배점</label>
						</div>
						<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
							<input type="number" class="form-control allot" name ="quesAllot\${cnt}" id="quesAllot\${cnt}">
						</div>
					</div>
				</div>
				
				<!-- 정답 -->
				<div class="form-group-inner">
					<div class="row">
						<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
							<label class="login2 pull-right pull-right-pro">정답</label>
						</div>
						<div class="col-lg-9 col-md-9 col-sm-9 col-xs-9">
							<div class="bt-df-checkbox">
							<%--
								<input class="pull-left radio-checked cnsr" type="radio" checked=""
								value="O" id="" name="quesCnsr\${cnt}">O
								<input class="pull-left snsr" type="radio"
								value="X" id="" name="quesCnsr\${cnt}">X --%>
								<input class="cnsr" checked type="radio" value="O" id="" name="quesCnsr\${cnt}">O
								<input class="cnsr"         type="radio" value="X" id="" name="quesCnsr\${cnt}">X
							</div>
						</div>
					</div>
				</div>

				<!-- 해설 -->
				<div class="form-group-inner">
					<div class="row">
						<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
							<label class="login2 pull-right pull-right-pro" for="quesExplna\${cnt}">해설</label>
						</div>
						<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
							<textarea rows="4" class ="form-control explna" name = "quesExplna\${cnt}" id ="quesExplna\${cnt}"></textarea>
						</div>
					</div>
				</div>
                `

        let temp = document.createElement("div");
        temp.innerHTML = str;
        addDiv.append(temp);
    }

    // 문항 삭제
    const delQues = function(){
        let targetDom = addDiv.lastChild;
        if(targetDom!=null){
        	targetDom.remove();
	        cnt--;
        }
    }
    
    // 단원 평가 등록
    const createUnitEvl = function(){
    	
    	let formData = new FormData();
    	
    	let title = document.querySelector("#title").value;
    	let startDt = document.querySelector("#startDt").value;
    	let endDt = document.querySelector("#endDt").value;
    	let startTm = document.querySelector("#startTm").value;
    	let endTm = document.querySelector("#endTm").value;
    	
    	console.log("title : " + title + ", startDt : " +  startDt + ", endDt : " + endDt + ", startTm : " + startTm + ", endTm : " + endTm);
    	
    	// 단원 평가
    	formData.append("unitEvlNm",title);
    	formData.append("unitEvlBeginDt",startDt + " " + startTm);//2024-03-08 04:27
    	formData.append("unitEvlEndDt",endDt + " " + endTm);	//2024-03-21 18:31
    	// 문항
    	$(".ques").each(function(idx,ques){
    		console.log("quesQues"+idx+":",$(this).val());
			formData.append("quesVOList["+idx+"].quesNo", idx+1);
			formData.append("quesVOList["+idx+"].quesQues", $(this).val());
		});
    	$(".allot").each(function(idx,explna){
    		console.log("quesAllot"+idx+":",$(this).val());
			formData.append("quesVOList["+idx+"].quesAllot", $(this).val());
		});
    	$(".cnsr:checked").each(function(idx,cnsr){
    		console.log("quesCnsr"+idx+":",$(this).val());
			formData.append("quesVOList["+idx+"].quesCnsr", $(this).val());
		});
    	$(".explna").each(function(idx,explna){
    		console.log("quesExplna"+idx+":",$(this).val());
			formData.append("quesVOList["+idx+"].quesExplna", $(this).val());
		});
    	
    	$.ajax({
            url :"/unitTest/createUnitTest",
            type:"post",
            processData : false,
			contentType : false,
            data:formData,
            dataType:"text",
            beforeSend:function(xhr){
				xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
			},
            success:function(res){
                if(res>0){
	            	alert("단원평가가 성공적으로 등록되었습니다.");
					// 목록으로 이동
	            	location.href = "/unitTest/list";
                }
                else{
	            	alert("단원평가 등록에 실패했습니다.");
                }
            },
            error:function(xhr){
                console.log(xhr.status);
            }
        })
    }
    
	 // 시험 생성 취소
    const cancelCreate = function(){
    	if(confirm("단원평가 생성을 취소하시겠습니까")){
			location.href = "/unitTest/list";
    	}
    }
	 
	 // 자동 입력
	const autoInput = function(){
		let today = new Date();   
		today = dateToMinFormat(today);
		 
		document.querySelector("#title").value = "test"+today;
		document.querySelector("#startDt").value = "2024-03-15";
		document.querySelector("#endDt").value = "2024-04-25";
		document.querySelector("#startTm").value = "15:00:00";
		document.querySelector("#endTm").value = "22:00:00";
		
		document.querySelector("#quesQues1").value = "문제1";
		document.querySelector("#quesAllot1").value = "20";
		document.querySelector("#quesExplna1").value = "해설1";
		
		document.querySelector("#quesQues2").value = "문제2";
		document.querySelector("#quesAllot2").value = "20";
		document.querySelector("#quesExplna2").value = "해설2";
		
		document.querySelector("#quesQues3").value = "문제3";
		document.querySelector("#quesAllot3").value = "20";
		document.querySelector("#quesExplna3").value = "해설3";
		
		document.querySelector("#quesQues4").value = "문제4";
		document.querySelector("#quesAllot4").value = "20";
		document.querySelector("#quesExplna4").value = "해설4";
		
		document.querySelector("#quesQues5").value = "문제5";
		document.querySelector("#quesAllot5").value = "20";
		document.querySelector("#quesExplna5").value = "해설5";
	}

</script>

<!-- 헤더 -->
<jsp:include page="unitTestHeader.jsp" flush="true"/>
<script>document.querySelector(".bread-blod").innerHTML = "생성";</script>

<div class="row">
	<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
		<div class="sparkline12-list">
			<div class="sparkline12-hd">
				<div class="main-sparkline12-hd">
					<h1>단원평가 생성</h1>
				</div>
			</div>
			<div class="sparkline12-graph">
				<div class="basic-login-form-ad">
					<div class="row">
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
							<div class="all-form-element-inner">
								<form action="">
									<div class="form-group-inner">
										<div class="row">
											<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
												<label class="login2 pull-right pull-right-pro" for="title">단원평가
													제목</label>
											</div>
											<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
												<input type="text" class="form-control" id="title">
											</div>
										</div>
									</div>
									<div class="form-group-inner">
										<div class="row">
											<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
												<label class="login2 pull-right pull-right-pro"
													for="startDt">시작 일자</label>
											</div>
											<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
												<input type="date" class="form-control" id="startDt">
											</div>
										</div>
									</div>

									<div class="form-group-inner">
										<div class="row">
											<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
												<label class="login2 pull-right pull-right-pro"
													for="startTm">시작 시간</label>
											</div>
											<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
												<input type="time" class="form-control" id="startTm">
											</div>
										</div>
									</div>

									<div class="form-group-inner">
										<div class="row">
											<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
												<label class="login2 pull-right pull-right-pro" for="endDt">종료
													일자</label>
											</div>
											<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
												<input type="date" class="form-control" id="endDt">
											</div>
										</div>
									</div>

									<div class="form-group-inner">
										<div class="row">
											<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
												<label class="login2 pull-right pull-right-pro" for="endTm">종료
													시간</label>
											</div>
											<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
												<input type="time" class="form-control" id="endTm">
											</div>
										</div>
									</div>

									<hr>
									<div id="quesDiv">
										<!-- 문제 번호 -->
										<div class="form-group-inner">
											<div class="row">
												<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
													<label class="login2 pull-right pull-right-pro">1번
														문제</label>
												</div>
												<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12"></div>
											</div>
										</div>

										<!-- 지문 -->
										<div class="form-group-inner">
											<div class="row">
												<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
													<label class="login2 pull-right pull-right-pro"
														for="quesQues1">지문</label>
												</div>
												<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
													<textarea rows="2" class="form-control ques"
														name="quesQues1" id="quesQues1"></textarea>
												</div>
											</div>
										</div>

										<!-- 배점 -->
										<div class="form-group-inner">
											<div class="row">
												<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
													<label class="login2 pull-right pull-right-pro"
														for="quesAllot1">배점</label>
												</div>
												<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
													<input type="number" class="form-control allot"
														name="quesAllot1" id="quesAllot1">
												</div>
											</div>
										</div>

										<!-- 정답 -->
										<div class="form-group-inner">
											<div class="row">
												<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
													<label class="login2 pull-right pull-right-pro">정답</label>
												</div>
												<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
													<div class="bt-df-checkbox">
														<input class="cnsr" checked type="radio" value="O" id=""
															name="cnsr1">O <input class="cnsr" type="radio"
															value="X" id="" name="cnsr1">X
													</div>
												</div>
											</div>
										</div>

										<!-- 해설 -->
										<div class="form-group-inner">
											<div class="row">
												<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
													<label class="login2 pull-right pull-right-pro"
														for="quesExplna1">해설</label>
												</div>
												<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
													<textarea rows="4" class="form-control explna"
														name="quesExplna1" id="quesExplna1"></textarea>
												</div>
											</div>
										</div>
									</div>

									<div id="addDiv"></div>

									<br>
									<div class="form-group-inner">
										<div class="row">
											<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
												<label class="login2 pull-right pull-right-pro" for=""></label>
											</div>
											<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
												<button
													class="btn btn-custon-four btn-primary waves-effect waves-light"
													type="button" onclick="addQues()">+</button>
												<button class="btn btn-custon-four btn-danger waves-effect"
													type="button" onclick="delQues()">-</button>
											</div>
										</div>
									</div>

									<br> <br> <br>
									<div class="form-group-inner">
										<div class="row">
											<div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
												<label class="login2 pull-right pull-right-pro" for=""></label>
											</div>
											<div class="col-lg-9 col-md-9 col-sm-9 col-xs-12 ">
												<button class="btn btn-white " type="button"
													onclick="autoInput()">자동 입력</button>
												<button class="btn btn-white " type="button"
													onclick="cancelCreate()">목록으로 돌아가기</button>
												<button class="btn btn-primary waves-light " type="button"
													onclick="createUnitEvl()">생성 완료</button>
											</div>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
